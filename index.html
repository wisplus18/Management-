<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eFootball League Manager PRO (Dark Theme)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- FIREBASE MODULE IMPORTS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, updateDoc, deleteDoc, runTransaction, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // =========================================================================
        // === CRITICAL STEP: FIREBASE CONFIGURATION (FOR EXTERNAL HOSTING) ===
        // 
        // This configuration block uses the details you provided.
        // It is necessary for running the app outside the Canvas environment.
        
        // 1. Static Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCLycBxpQ3MMIDLYjmBqMZv32FIu2eDXF4",
            authDomain: "efootball-app-ce90b.firebaseapp.com",
            projectId: "efootball-app-ce90b",
            storageBucket: "efootball-app-ce90b.firebasestorage.app",
            messagingSenderId: "387933114333",
            appId: "1:387933114333:web:1c85dbadacf70d0406b034"
        };
        
        // IMPORTANT: When hosting externally, the 'appId' needs to be derived
        // from the config or defined statically for data path consistency.
        const appId = 'efootball-app-ce90b'; // Using projectId as a consistent App ID

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('debug'); // Set log level for debugging

        // Global state
        let currentUserId = null;
        let isAdmin = false;

        // 2. Authentication and App Start
        async function authenticateAndStart() {
            try {
                // For external hosting, we sign in anonymously to get a UID
                const userCredential = await signInAnonymously(auth);
                const user = userCredential.user;
                currentUserId = user.uid;
                
                // Once authenticated, start the app
                await window.initializeApp(user.uid);

            } catch (error) {
                console.error("Firebase Anonymous Auth failed:", error);
                // Fallback UI or error message if auth fails
                document.getElementById('user-id-display').textContent = 'AUTH FAILED';
                window.showMessageBox("Authentication failed. Cannot load data.", 'error');
            }
        }

        // 3. Auth State Listener (Mostly for safety and initial check)
        onAuthStateChanged(auth, async (user) => {
            if (user && user.uid !== currentUserId) {
                // If a user was already authenticated, ensure we update the current user ID
                currentUserId = user.uid;
                if (window.initializeApp) {
                     // Check if app initialization is pending
                     await window.initializeApp(user.uid);
                }
            } else if (!user) {
                console.log("User signed out.");
            }
        });

        // 4. Run Authentication immediately
        authenticateAndStart();
        
        // Expose Firebase instances globally and keep user's original placeholder function
        window.db = db;
        window.auth = auth;
        window.initializeApp = async function(userId) {
            // Placeholder for data fetching logic
            console.log(`User ${userId} authenticated. Starting app...`);
        }
        
    </script>
    <!-- Load Icon library for use in components -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1e1e2d; /* Dark theme background */
            color: #d1d5db; /* Light gray text */
        }
        
        /* Custom class for dark-mode scrollbars */
        .dark-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .dark-scrollbar::-webkit-scrollbar-track {
            background: #2d2d3e;
            border-radius: 10px;
        }

        .dark-scrollbar::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 10px;
        }

        .dark-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #5a6578;
        }

        /* Custom style for the input placeholder text color */
        .input-dark::placeholder {
            color: #9ca3af;
            opacity: 1; /* For Firefox */
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-6 lg:p-8">

    <!-- Global State Variables for UI -->
    <script>
        // UI State
        window.leagueData = null;
        window.isEditing = false;
        window.isModalOpen = false;
        window.activeView = 'standings'; // 'standings', 'fixtures', 'teams', 'admin'
        
        // Temp storage for the current team/fixture being edited
        window.currentEditItem = null;
        
        // Admin PIN check function
        window.checkPin = function() {
            const pinInput = document.getElementById('pin-input').value.trim().toUpperCase();
            // PIN is 'PES' (The popular Konami soccer franchise)
            if (pinInput === 'PES') { 
                isAdmin = true;
                window.renderApp();
                document.getElementById('pin-modal').classList.add('hidden');
                document.getElementById('message-box-text').textContent = "Admin privileges granted. You can now edit data.";
                document.getElementById('message-box').classList.remove('opacity-0', 'scale-95', 'hidden');
                document.getElementById('message-box').classList.add('opacity-100', 'scale-100');
                setTimeout(() => {
                    document.getElementById('message-box').classList.remove('opacity-100', 'scale-100');
                    document.getElementById('message-box').classList.add('opacity-0', 'scale-95');
                }, 3000);
            } else {
                document.getElementById('pin-input').value = '';
                document.getElementById('pin-input').classList.add('border-red-500', 'ring-2', 'ring-red-500');
                setTimeout(() => {
                    document.getElementById('pin-input').classList.remove('border-red-500', 'ring-2', 'ring-red-500');
                }, 1000);
            }
        };

        // Utility function to generate a random ID
        window.generateId = () => Date.now().toString(36) + Math.random().toString(36).substring(2, 5);
    </script>

    <!-- Main Application Container -->
    <div id="app" class="max-w-4xl mx-auto bg-gray-900 rounded-3xl shadow-2xl p-4 sm:p-6 lg:p-8 border border-indigo-900/50">
        
        <!-- Header -->
        <header class="mb-8">
            <div class="flex items-center justify-between">
                <h1 class="text-3xl sm:text-4xl font-extrabold text-indigo-400">
                    <i class="fas fa-trophy mr-2"></i>
                    eLeague Manager
                </h1>
                <div class="text-right text-xs text-gray-500">
                    <p>User ID: <span id="user-id-display" class="font-mono text-indigo-300">Loading...</span></p>
                    <p>App ID: <span id="app-id-display" class="font-mono text-indigo-300">Loading...</span></p>
                </div>
            </div>
            <p class="text-gray-400 mt-2 text-md">
                Manage your personalized, real-time eFootball league statistics.
            </p>
        </header>

        <!-- Navigation Tabs -->
        <nav class="mb-8 p-1 bg-gray-800 rounded-xl shadow-inner flex space-x-2">
            <!-- Standings Tab -->
            <button onclick="window.activeView = 'standings'; window.renderApp()" 
                    class="tab-button w-1/4 p-3 rounded-xl font-semibold text-center transition-all duration-200">
                <i class="fas fa-chart-bar mr-2"></i> Standings
            </button>
            <!-- Fixtures Tab -->
            <button onclick="window.activeView = 'fixtures'; window.renderApp()" 
                    class="tab-button w-1/4 p-3 rounded-xl font-semibold text-center transition-all duration-200">
                <i class="fas fa-calendar-alt mr-2"></i> Fixtures
            </button>
            <!-- Teams Tab -->
            <button onclick="window.activeView = 'teams'; window.renderApp()" 
                    class="tab-button w-1/4 p-3 rounded-xl font-semibold text-center transition-all duration-200">
                <i class="fas fa-users mr-2"></i> Teams
            </button>
            <!-- Admin Tab -->
            <button onclick="window.activeView = 'admin'; window.renderApp()" 
                    class="tab-button w-1/4 p-3 rounded-xl font-semibold text-center transition-all duration-200">
                <i class="fas fa-cog mr-2"></i> Admin
            </button>
        </nav>

        <!-- Main Content Area -->
        <div id="content-area">
            <!-- Content will be rendered here by JavaScript -->
            <div class="text-center p-12 text-gray-500">
                <i class="fas fa-spinner fa-spin text-4xl mb-3 text-indigo-500"></i>
                <p class="font-semibold">Loading League Data...</p>
            </div>
        </div>

    </div>

    <!-- Admin PIN Modal -->
    <div id="pin-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 transition-opacity" onclick="document.getElementById('pin-modal').classList.add('hidden')">
        <div class="bg-gray-800 p-6 rounded-2xl shadow-2xl w-full max-w-sm transform transition-all duration-300" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold text-indigo-400 mb-2">Admin Access Required</h3>
            <p class="text-gray-400 mb-4">Enter the PIN to gain Administrator privileges.</p>
            
            <label for="pin-input" class="block text-sm font-medium text-gray-300 mb-1">
                What is the name of the popular Konami soccer franchise this league is played on?
            </label>
            <input type="password" id="pin-input" placeholder="Hint: Three letters" required class="w-full p-3 border border-gray-600 bg-gray-700 rounded-lg mb-6 text-center text-xl font-mono tracking-widest uppercase input-dark focus:ring-indigo-500 focus:border-indigo-500">

            <div class="flex justify-end space-x-3">
                <button onclick="document.getElementById('pin-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-600 text-gray-200 font-semibold rounded-lg hover:bg-gray-700 transition-colors">
                    Cancel
                </button>
                <button onclick="window.checkPin()" class="px-4 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-500/50">
                    Submit
                </button>
            </div>
        </div>
    </div>
    
    <!-- Custom Message Box (Replaces alert()) -->
    <div id="message-box" class="fixed bottom-5 right-5 bg-indigo-600 text-white p-4 rounded-xl shadow-xl transform transition-all duration-500 z-50 opacity-0 scale-95 hidden">
        <p id="message-box-text" class="font-semibold"></p>
    </div>


    <!-- Main Application Logic (Rendering and Data Handling) -->
    <script type="module">
        // Import all required functions here
        import { doc, setDoc, onSnapshot, collection, query, updateDoc, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global instances are set in the init script, but we ensure they are available
        const db = window.db;
        const auth = window.auth;
        const appId = window.appId; // Use the globally exposed appId
        
        // --- Component Rendering Functions ---

        // Render the standings view
        function renderStandings() {
            if (!window.leagueData || !window.leagueData.teams || window.leagueData.teams.length === 0) {
                return '<div class="text-center p-8 text-gray-500"><i class="fas fa-exclamation-circle text-4xl mb-3"></i><p>No teams defined yet. Go to the Teams tab to add them!</p></div>';
            }

            // 1. Calculate Standings
            const standings = window.leagueData.teams.map(team => {
                const teamStats = {
                    id: team.id,
                    name: team.name,
                    icon: team.icon,
                    P: 0, W: 0, D: 0, L: 0, GF: 0, GA: 0, GD: 0, PTS: 0
                };

                (window.leagueData.fixtures || []).forEach(fixture => {
                    if (fixture.scoreA !== null && fixture.scoreB !== null) {
                        const scoreA = parseInt(fixture.scoreA, 10);
                        const scoreB = parseInt(fixture.scoreB, 10);

                        if (fixture.teamA === team.id) {
                            teamStats.P += 1;
                            teamStats.GF += scoreA;
                            teamStats.GA += scoreB;
                            if (scoreA > scoreB) { teamStats.W += 1; teamStats.PTS += 3; }
                            else if (scoreA === scoreB) { teamStats.D += 1; teamStats.PTS += 1; }
                            else { teamStats.L += 1; }
                        } else if (fixture.teamB === team.id) {
                            teamStats.P += 1;
                            teamStats.GF += scoreB;
                            teamStats.GA += scoreA;
                            if (scoreB > scoreA) { teamStats.W += 1; teamStats.PTS += 3; }
                            else if (scoreB === scoreA) { teamStats.D += 1; teamStats.PTS += 1; }
                            else { teamStats.L += 1; }
                        }
                    }
                });

                teamStats.GD = teamStats.GF - teamStats.GA;
                return teamStats;
            });

            // 2. Sort Standings: PTS (desc), GD (desc), GF (desc)
            standings.sort((a, b) => {
                if (b.PTS !== a.PTS) return b.PTS - a.PTS;
                if (b.GD !== a.GD) return b.GD - a.GD;
                return b.GF - a.GF;
            });

            // 3. Generate HTML
            let html = `
                <h2 class="text-2xl font-bold text-indigo-400 mb-4 flex items-center">
                    <i class="fas fa-table mr-2"></i> Current League Standings
                </h2>
                <div class="overflow-x-auto rounded-xl shadow-lg border border-gray-700">
                    <table class="min-w-full divide-y divide-gray-700 bg-gray-800">
                        <thead class="bg-gray-700/50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-400 uppercase tracking-wider w-8">#</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-400 uppercase tracking-wider">Team</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">P</th>
                                <th class="hidden sm:table-cell px-4 py-3 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">W</th>
                                <th class="hidden sm:table-cell px-4 py-3 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">D</th>
                                <th class="hidden sm:table-cell px-4 py-3 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">L</th>
                                <th class="hidden md:table-cell px-4 py-3 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">GF</th>
                                <th class="hidden md:table-cell px-4 py-3 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">GA</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">GD</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-400 uppercase tracking-wider text-indigo-300">PTS</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700">
                            ${standings.map((s, index) => `
                                <tr class="hover:bg-gray-700/50 transition-colors">
                                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-500 text-center">${index + 1}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-gray-200">
                                        <i class="${s.icon} mr-2 text-indigo-400"></i> ${s.name}
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-center font-bold text-gray-300">${s.P}</td>
                                    <td class="hidden sm:table-cell px-4 py-3 whitespace-nowrap text-sm text-center text-gray-400">${s.W}</td>
                                    <td class="hidden sm:table-cell px-4 py-3 whitespace-nowrap text-sm text-center text-gray-400">${s.D}</td>
                                    <td class="hidden sm:table-cell px-4 py-3 whitespace-nowrap text-sm text-center text-gray-400">${s.L}</td>
                                    <td class="hidden md:table-cell px-4 py-3 whitespace-nowrap text-sm text-center text-gray-400">${s.GF}</td>
                                    <td class="hidden md:table-cell px-4 py-3 whitespace-nowrap text-sm text-center text-gray-400">${s.GA}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-center font-bold ${s.GD > 0 ? 'text-green-400' : s.GD < 0 ? 'text-red-400' : 'text-yellow-400'}">${s.GD}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-center font-extrabold text-indigo-300">${s.PTS}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            return html;
        }

        // Render the fixtures view
        function renderFixtures() {
            const teamsMap = (window.leagueData.teams || []).reduce((acc, team) => {
                acc[team.id] = team;
                return acc;
            }, {});
            
            const fixtures = window.leagueData.fixtures || [];

            // Sort fixtures by status (Completed, Upcoming, In Progress - though we don't track In Progress here)
            // Completed games first (with score), then upcoming (score is null)
            fixtures.sort((a, b) => {
                const statusA = (a.scoreA !== null && a.scoreB !== null) ? 1 : 0;
                const statusB = (b.scoreA !== null && b.scoreB !== null) ? 1 : 0;
                return statusB - statusA;
            });
            
            let html = `
                <h2 class="text-2xl font-bold text-indigo-400 mb-4 flex items-center">
                    <i class="fas fa-calendar-alt mr-2"></i> League Fixtures
                    ${isAdmin ? `<button onclick="window.showFixtureEditor(null)" class="ml-4 px-3 py-1 bg-green-600 text-white text-sm font-bold rounded-lg hover:bg-green-700 transition-colors shadow-md shadow-green-500/50">
                        <i class="fas fa-plus mr-1"></i> Add Fixture
                    </button>` : ''}
                </h2>
                <div class="space-y-4 dark-scrollbar h-[60vh] overflow-y-auto pr-2">
                    ${fixtures.length === 0 ? 
                        '<div class="text-center p-8 text-gray-500"><i class="fas fa-calendar-times text-4xl mb-3"></i><p>No fixtures defined yet.</p></div>'
                        : 
                        fixtures.map(fixture => {
                            const teamA = teamsMap[fixture.teamA] || { name: 'Unknown Team', icon: 'fas fa-question-circle' };
                            const teamB = teamsMap[fixture.teamB] || { name: 'Unknown Team', icon: 'fas fa-question-circle' };
                            const isCompleted = fixture.scoreA !== null && fixture.scoreB !== null;
                            const cardClass = isCompleted ? 'bg-gray-800/80 border-gray-700' : 'bg-gray-800 border-indigo-600/50 shadow-lg shadow-indigo-900/50';
                            
                            return `
                                <div class="${cardClass} p-4 rounded-xl flex items-center justify-between transition-all duration-300 hover:shadow-indigo-500/20 hover:border-indigo-500">
                                    <!-- Teams -->
                                    <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4 w-3/5">
                                        <div class="flex items-center text-lg font-bold w-full sm:w-auto">
                                            <i class="${teamA.icon} mr-2 text-indigo-400"></i> ${teamA.name}
                                        </div>
                                        <span class="text-sm font-mono text-gray-500 hidden sm:block">vs</span>
                                        <div class="flex items-center text-lg font-bold w-full sm:w-auto">
                                            <i class="${teamB.icon} mr-2 text-indigo-400"></i> ${teamB.name}
                                        </div>
                                    </div>

                                    <!-- Score/Status & Actions -->
                                    <div class="flex flex-col sm:flex-row items-end sm:items-center space-y-2 sm:space-y-0 sm:space-x-4">
                                        <div class="text-xl font-extrabold w-24 text-center">
                                            ${isCompleted 
                                                ? `<span class="text-gray-200">${fixture.scoreA}</span><span class="text-indigo-400 mx-2">-</span><span class="text-gray-200">${fixture.scoreB}</span>` 
                                                : `<span class="text-yellow-500 text-sm font-semibold">Upcoming</span>`
                                            }
                                        </div>
                                        ${isAdmin ? `
                                            <button onclick="window.showFixtureEditor('${fixture.id}')" 
                                                    class="p-2 text-sm bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition-colors">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')
                    }
                </div>
            `;
            return html;
        }

        // Render the teams view
        function renderTeams() {
            let html = `
                <h2 class="text-2xl font-bold text-indigo-400 mb-4 flex items-center">
                    <i class="fas fa-users mr-2"></i> Participating Teams
                    ${isAdmin ? `<button onclick="window.showTeamEditor(null)" class="ml-4 px-3 py-1 bg-green-600 text-white text-sm font-bold rounded-lg hover:bg-green-700 transition-colors shadow-md shadow-green-500/50">
                        <i class="fas fa-plus mr-1"></i> Add Team
                    </button>` : ''}
                </h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    ${(window.leagueData.teams || []).map(team => `
                        <div class="bg-gray-800 p-4 rounded-xl flex items-center justify-between border border-gray-700 hover:bg-gray-700/50 transition-colors">
                            <div class="flex items-center">
                                <i class="${team.icon} text-3xl mr-4 text-indigo-400"></i>
                                <div>
                                    <p class="text-lg font-semibold text-gray-200">${team.name}</p>
                                    <p class="text-sm text-gray-500 font-mono">${team.id}</p>
                                </div>
                            </div>
                            ${isAdmin ? `
                                <div class="flex space-x-2">
                                    <button onclick="window.showTeamEditor('${team.id}')" 
                                            class="p-2 text-sm bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition-colors">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="window.deleteTeam('${team.id}')" 
                                            class="p-2 text-sm bg-red-600 text-white rounded-full hover:bg-red-700 transition-colors">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
            return html;
        }

        // Render the admin view
        function renderAdmin() {
            const hasAdminAccess = isAdmin;
            
            let html = `
                <h2 class="text-2xl font-bold text-indigo-400 mb-4 flex items-center">
                    <i class="fas fa-user-shield mr-2"></i> Admin Panel
                </h2>
                
                <div class="bg-gray-800 p-6 rounded-xl space-y-4 border border-gray-700">
                    <p class="text-lg font-semibold text-gray-200">Admin Status:</p>
                    <div class="flex items-center space-x-3">
                        <span id="admin-status" class="px-4 py-2 rounded-full font-bold ${hasAdminAccess ? 'bg-green-600' : 'bg-red-600'} text-white">
                            ${hasAdminAccess ? 'ACCESS GRANTED' : 'ACCESS DENIED'}
                        </span>
                        ${!hasAdminAccess ? 
                            `<button onclick="document.getElementById('pin-modal').classList.remove('hidden')" 
                                    class="px-4 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-500/50">
                                Gain Admin Access
                            </button>` 
                            : ''}
                    </div>
                </div>
                
                ${hasAdminAccess ? `
                    <div class="mt-8 bg-gray-800 p-6 rounded-xl space-y-4 border border-gray-700">
                        <p class="text-lg font-semibold text-indigo-400">Data Management Tools</p>
                        <button onclick="window.deleteAllData()" 
                                class="w-full px-4 py-3 bg-red-700 text-white font-bold rounded-lg hover:bg-red-800 transition-colors shadow-lg shadow-red-500/50">
                            <i class="fas fa-exclamation-triangle mr-2"></i> DELETE ALL LEAGUE DATA
                        </button>
                        <p class="text-sm text-gray-500">
                            <span class="font-bold text-yellow-500">Warning:</span> This action is permanent and will remove all teams and fixtures from the database.
                        </p>
                    </div>
                ` : ''}
            `;
            return html;
        }

        // --- Editor Modals ---

        function getTeamIconOptions(selectedIcon) {
            const icons = [
                'fas fa-shield-alt', 'fas fa-futbol', 'fas fa-bolt', 'fas fa-dragon', 
                'fas fa-ghost', 'fas fa-crown', 'fas fa-rocket', 'fas fa-mask', 
                'fas fa-horse', 'fas fa-spider', 'fas fa-feather-alt'
            ];
            return icons.map(icon => `
                <div class="flex items-center">
                    <input type="radio" id="icon-${icon.split(' ')[1]}" name="icon" value="${icon}" ${selectedIcon === icon ? 'checked' : ''} class="hidden">
                    <label for="icon-${icon.split(' ')[1]}" class="flex items-center justify-center w-12 h-12 border-2 border-gray-600 rounded-lg cursor-pointer hover:border-indigo-500 transition-all ${selectedIcon === icon ? 'bg-indigo-600 border-indigo-600' : 'bg-gray-700'}">
                        <i class="${icon} text-xl text-white"></i>
                    </label>
                </div>
            `).join('');
        }

        window.showTeamEditor = function(teamId) {
            window.currentEditItem = null;
            let team = { id: window.generateId(), name: '', icon: 'fas fa-shield-alt' };
            const isNew = teamId === null;

            if (!isNew) {
                team = (window.leagueData.teams || []).find(t => t.id === teamId) || team;
                window.currentEditItem = team;
            }

            const editorHtml = `
                <h3 class="text-xl font-bold text-indigo-400 mb-4">${isNew ? 'Add New Team' : `Edit Team: ${team.name}`}</h3>
                
                <div class="mb-4">
                    <label for="team-name" class="block text-sm font-medium text-gray-300 mb-1">Team Name</label>
                    <input type="text" id="team-name" value="${team.name}" placeholder="e.g., Phoenix FC" required 
                           class="w-full p-3 border border-gray-600 bg-gray-700 rounded-lg text-white input-dark focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Team Icon</label>
                    <div id="icon-picker" class="flex flex-wrap gap-2">
                        ${getTeamIconOptions(team.icon)}
                    </div>
                </div>

                <div class="flex justify-end space-x-3">
                    <button onclick="window.closeModal()" class="px-4 py-2 bg-gray-600 text-gray-200 font-semibold rounded-lg hover:bg-gray-700 transition-colors">
                        Cancel
                    </button>
                    <button onclick="window.saveTeam('${team.id}', ${isNew})" class="px-4 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition-colors">
                        ${isNew ? 'Create Team' : 'Save Changes'}
                    </button>
                </div>
            `;
            window.openModal(editorHtml);
        };
        
        window.showFixtureEditor = function(fixtureId) {
            window.currentEditItem = null;
            const isNew = fixtureId === null;
            let fixture = { id: window.generateId(), teamA: '', teamB: '', scoreA: null, scoreB: null };

            if (!isNew) {
                fixture = (window.leagueData.fixtures || []).find(f => f.id === fixtureId) || fixture;
                window.currentEditItem = fixture;
            }

            const teams = window.leagueData.teams || [];
            if (teams.length < 2) {
                 window.showMessageBox("Please add at least two teams before creating a fixture.", 'error');
                 return;
            }

            const teamOptions = (selectedId) => teams.map(t => 
                `<option value="${t.id}" ${t.id === selectedId ? 'selected' : ''}>${t.name}</option>`
            ).join('');
            
            const scoreDisplay = fixture.scoreA !== null ? `${fixture.scoreA} - ${fixture.scoreB}` : 'Upcoming';
            
            const editorHtml = `
                <h3 class="text-xl font-bold text-indigo-400 mb-4">${isNew ? 'Add New Fixture' : `Edit Fixture (${scoreDisplay})`}</h3>
                
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <!-- Team A Selector -->
                    <div class="w-full sm:w-1/2">
                        <label for="fixture-teamA" class="block text-sm font-medium text-gray-300 mb-1">Team A (Home)</label>
                        <select id="fixture-teamA" class="w-full p-3 border border-gray-600 bg-gray-700 rounded-lg text-white focus:ring-indigo-500 focus:border-indigo-500">
                            ${teamOptions(fixture.teamA)}
                        </select>
                    </div>
                    <!-- Team B Selector -->
                    <div class="w-full sm:w-1/2">
                        <label for="fixture-teamB" class="block text-sm font-medium text-gray-300 mb-1">Team B (Away)</label>
                        <select id="fixture-teamB" class="w-full p-3 border border-gray-600 bg-gray-700 rounded-lg text-white focus:ring-indigo-500 focus:border-indigo-500">
                            ${teamOptions(fixture.teamB)}
                        </select>
                    </div>
                </div>

                <div class="mb-6 border-t border-gray-700 pt-4">
                    <p class="block text-sm font-medium text-gray-300 mb-2">Match Result (Leave blank for upcoming match)</p>
                    <div class="flex gap-4 items-center">
                        <div class="w-1/2">
                            <label for="fixture-scoreA" class="sr-only">Score A</label>
                            <input type="number" id="fixture-scoreA" value="${fixture.scoreA === null ? '' : fixture.scoreA}" placeholder="Score A" 
                                   class="w-full p-3 border border-gray-600 bg-gray-700 rounded-lg text-white text-center text-xl font-bold focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <span class="text-2xl font-bold text-indigo-400">-</span>
                        <div class="w-1/2">
                            <label for="fixture-scoreB" class="sr-only">Score B</label>
                            <input type="number" id="fixture-scoreB" value="${fixture.scoreB === null ? '' : fixture.scoreB}" placeholder="Score B" 
                                   class="w-full p-3 border border-gray-600 bg-gray-700 rounded-lg text-white text-center text-xl font-bold focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center">
                    ${!isNew ? `
                        <button onclick="window.deleteFixture('${fixture.id}')" class="px-4 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors">
                            Delete
                        </button>
                    ` : '<div></div>'}
                    <div class="flex space-x-3">
                        <button onclick="window.closeModal()" class="px-4 py-2 bg-gray-600 text-gray-200 font-semibold rounded-lg hover:bg-gray-700 transition-colors">
                            Cancel
                        </button>
                        <button onclick="window.saveFixture('${fixture.id}', ${isNew})" class="px-4 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition-colors">
                            ${isNew ? 'Create Fixture' : 'Update Fixture'}
                        </button>
                    </div>
                </div>
            `;
            window.openModal(editorHtml);
        };
        
        window.openModal = function(contentHtml) {
            window.isModalOpen = true;
            window.renderApp(); // Re-render to show the overlay/modal structure
            const contentArea = document.getElementById('modal-content-area');
            if (contentArea) {
                contentArea.innerHTML = contentHtml;
                document.getElementById('edit-modal').classList.remove('hidden');
            }
        }
        
        window.closeModal = function() {
            window.isModalOpen = false;
            window.currentEditItem = null;
            document.getElementById('edit-modal').classList.add('hidden');
            window.renderApp();
        }

        window.showMessageBox = function(message, type = 'info') {
            const box = document.getElementById('message-box');
            const text = document.getElementById('message-box-text');

            box.classList.remove('bg-indigo-600', 'bg-red-600', 'bg-green-600', 'hidden', 'opacity-100', 'scale-100');
            box.classList.add('opacity-0', 'scale-95');

            if (type === 'error') {
                box.classList.add('bg-red-600');
            } else if (type === 'success') {
                box.classList.add('bg-green-600');
            } else {
                box.classList.add('bg-indigo-600');
            }

            text.textContent = message;

            setTimeout(() => {
                box.classList.remove('hidden', 'opacity-0', 'scale-95');
                box.classList.add('opacity-100', 'scale-100');
            }, 10);

            setTimeout(() => {
                box.classList.remove('opacity-100', 'scale-100');
                box.classList.add('opacity-0', 'scale-95');
                setTimeout(() => box.classList.add('hidden'), 500);
            }, 3000);
        }

        // --- Firestore Data Operations ---

        // Get the collection path for league data (Public data for sharing)
        function getLeagueCollectionPath() {
            const userId = auth.currentUser?.uid || 'anonymous';
            // Use the static appId declared in the top script block
            return `artifacts/${appId}/public/data/league_${userId.substring(0, 8)}`;
        }
        
        // Save Team Data
        window.saveTeam = async function(teamId, isNew) {
            if (!isAdmin) {
                window.showMessageBox("You need Admin privileges to save data.", 'error');
                return;
            }
            
            const teamName = document.getElementById('team-name').value.trim();
            const iconElement = document.querySelector('#icon-picker input[name="icon"]:checked');
            const teamIcon = iconElement ? iconElement.value : 'fas fa-shield-alt';
            
            if (!teamName) {
                window.showMessageBox("Team name cannot be empty.", 'error');
                return;
            }

            const teamData = {
                id: teamId,
                name: teamName,
                icon: teamIcon
            };
            
            try {
                const teams = window.leagueData.teams || [];
                let newTeams;
                
                if (isNew) {
                    newTeams = [...teams, teamData];
                } else {
                    newTeams = teams.map(t => t.id === teamId ? teamData : t);
                }
                
                await setDoc(doc(db, getLeagueCollectionPath(), 'data'), {
                    ...window.leagueData, // spread existing data
                    teams: newTeams
                });
                
                window.showMessageBox(`Team ${teamName} saved successfully!`, 'success');
                window.closeModal();
            } catch (e) {
                console.error("Error saving team: ", e);
                window.showMessageBox("Error saving team data.", 'error');
            }
        }
        
        // Delete Team Data
        window.deleteTeam = async function(teamId) {
            if (!isAdmin) {
                window.showMessageBox("You need Admin privileges to delete data.", 'error');
                return;
            }

            const confirmDelete = await window.confirmAction('Are you sure you want to delete this team? All associated fixtures will remain.');
            if (!confirmDelete) return;

            try {
                const teams = (window.leagueData.teams || []).filter(t => t.id !== teamId);
                
                await setDoc(doc(db, getLeagueCollectionPath(), 'data'), {
                    ...window.leagueData,
                    teams: teams
                });
                
                window.showMessageBox(`Team deleted successfully!`, 'success');
            } catch (e) {
                console.error("Error deleting team: ", e);
                window.showMessageBox("Error deleting team data.", 'error');
            }
        }
        
        // Save Fixture Data
        window.saveFixture = async function(fixtureId, isNew) {
            if (!isAdmin) {
                window.showMessageBox("You need Admin privileges to save data.", 'error');
                return;
            }
            
            const teamA = document.getElementById('fixture-teamA').value;
            const teamB = document.getElementById('fixture-teamB').value;
            const scoreAInput = document.getElementById('fixture-scoreA').value.trim();
            const scoreBInput = document.getElementById('fixture-scoreB').value.trim();
            
            if (teamA === teamB) {
                window.showMessageBox("A team cannot play against itself.", 'error');
                return;
            }
            
            let scoreA = null;
            let scoreB = null;

            // Handle score input: must be either both null/empty (upcoming) or both valid numbers
            if (scoreAInput !== '' && scoreBInput !== '') {
                scoreA = parseInt(scoreAInput, 10);
                scoreB = parseInt(scoreBInput, 10);
                if (isNaN(scoreA) || isNaN(scoreB) || scoreA < 0 || scoreB < 0) {
                    window.showMessageBox("Scores must be non-negative integers or both left blank.", 'error');
                    return;
                }
            } else if (scoreAInput !== '' || scoreBInput !== '') {
                window.showMessageBox("Scores must be either both present or both absent (for upcoming).", 'error');
                return;
            }

            const fixtureData = {
                id: fixtureId,
                teamA: teamA,
                teamB: teamB,
                scoreA: scoreA,
                scoreB: scoreB
            };

            try {
                const fixtures = window.leagueData.fixtures || [];
                let newFixtures;
                
                if (isNew) {
                    newFixtures = [...fixtures, fixtureData];
                } else {
                    newFixtures = fixtures.map(f => f.id === fixtureId ? fixtureData : f);
                }

                await setDoc(doc(db, getLeagueCollectionPath(), 'data'), {
                    ...window.leagueData,
                    fixtures: newFixtures
                });
                
                window.showMessageBox(`Fixture updated successfully!`, 'success');
                window.closeModal();
            } catch (e) {
                console.error("Error saving fixture: ", e);
                window.showMessageBox("Error saving fixture data.", 'error');
            }
        }
        
        // Delete Fixture Data
        window.deleteFixture = async function(fixtureId) {
            if (!isAdmin) {
                window.showMessageBox("You need Admin privileges to delete data.", 'error');
                return;
            }
            
            const confirmDelete = await window.confirmAction('Are you sure you want to delete this fixture?');
            if (!confirmDelete) return;

            try {
                const fixtures = (window.leagueData.fixtures || []).filter(f => f.id !== fixtureId);
                
                await setDoc(doc(db, getLeagueCollectionPath(), 'data'), {
                    ...window.leagueData,
                    fixtures: fixtures
                });
                
                window.showMessageBox(`Fixture deleted successfully!`, 'success');
                window.closeModal();
            } catch (e) {
                console.error("Error deleting fixture: ", e);
                window.showMessageBox("Error deleting fixture data.", 'error');
            }
        }
        
        // Delete All Data (Admin Only)
        window.deleteAllData = async function() {
            if (!isAdmin) {
                window.showMessageBox("You need Admin privileges to delete all data.", 'error');
                return;
            }
            
            const confirmDelete = await window.confirmAction('Are you absolutely sure you want to delete ALL league data? This is irreversible.');
            if (!confirmDelete) return;

            try {
                await setDoc(doc(db, getLeagueCollectionPath(), 'data'), {
                    teams: [],
                    fixtures: []
                });
                
                window.showMessageBox(`All league data has been successfully deleted!`, 'success');
            } catch (e) {
                console.error("Error deleting all data: ", e);
                window.showMessageBox("Error deleting all data.", 'error');
            }
        }

        // --- Main App Initialization and Render Loop ---
        
        // Custom confirmation modal (replacing window.confirm)
        window.confirmAction = (message) => {
            const confirmation = document.createElement('div');
            confirmation.className = "fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 transition-opacity";
            confirmation.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-2xl shadow-2xl w-full max-w-sm" onclick="event.stopPropagation()">
                    <h3 class="text-xl font-bold text-red-400 mb-2">Confirmation Required</h3>
                    <p class="text-gray-400 mb-6">${message}</p>
                    <div class="flex justify-end space-x-3">
                        <button id="cancel-btn" class="px-4 py-2 bg-gray-600 text-gray-200 font-semibold rounded-lg hover:bg-gray-700 transition-colors">
                            Cancel
                        </button>
                        <button id="confirm-btn" class="px-4 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors">
                            Confirm
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmation);

            return new Promise(resolve => {
                document.getElementById('confirm-btn').onclick = () => {
                    document.body.removeChild(confirmation);
                    resolve(true);
                };
                document.getElementById('cancel-btn').onclick = () => {
                    document.body.removeChild(confirmation);
                    resolve(false);
                };
            });
        };
        
        // Main render function (called whenever state changes)
        window.renderApp = function() {
            const contentArea = document.getElementById('content-area');
            let contentHtml = '';
            
            // Set the active tab styling
            document.querySelectorAll('.tab-button').forEach(btn => {
                const view = btn.getAttribute('onclick').match(/'(.*?)\'/)[1];
                if (view === window.activeView) {
                    btn.classList.add('bg-indigo-600', 'text-white', 'shadow-lg', 'shadow-indigo-500/50');
                    btn.classList.remove('text-gray-400', 'hover:bg-gray-700');
                } else {
                    btn.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg', 'shadow-indigo-500/50');
                    btn.classList.add('text-gray-400', 'hover:bg-gray-700');
                }
            });

            switch(window.activeView) {
                case 'standings':
                    contentHtml = renderStandings();
                    break;
                case 'fixtures':
                    contentHtml = renderFixtures();
                    break;
                case 'teams':
                    contentHtml = renderTeams();
                    break;
                case 'admin':
                    contentHtml = renderAdmin();
                    break;
                default:
                    contentHtml = '<div class="text-center p-8 text-gray-500">View not found.</div>';
            }
            
            contentArea.innerHTML = contentHtml;
        };

        // This is called AFTER the user is authenticated (from the init script above)
        window.initializeApp = async function(userId) {
            const docPath = getLeagueCollectionPath();
            
            // Update User/App IDs on UI
            document.getElementById('user-id-display').textContent = userId;
            document.getElementById('app-id-display').textContent = appId;
            
            // Set up real-time listener for league data
            onSnapshot(doc(db, docPath, 'data'), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    // Data exists, use it
                    window.leagueData = docSnapshot.data();
                    console.log("League data updated from Firestore.");
                } else {
                    // Document does not exist, create initial structure
                    console.log("No league data found, initializing structure...");
                    window.leagueData = { teams: [], fixtures: [] };
                    // Set initial document structure immediately to ensure the listener works
                    setDoc(doc(db, docPath, 'data'), window.leagueData).catch(e => console.error("Error setting initial data:", e));
                }
                
                // Re-render the application with the new data
                window.renderApp();
            }, (error) => {
                console.error("Error listening to league data:", error);
                document.getElementById('content-area').innerHTML = '<div class="text-center p-8 text-red-500"><i class="fas fa-exclamation-triangle text-4xl mb-3"></i><p>Error loading data. Check console for details.</p></div>';
            });
            
            // Initial render
            window.renderApp();
        };

        // Create the editor modal structure once in the body
        document.body.insertAdjacentHTML('beforeend', `
            <!-- Global Editor Modal -->
            <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 transition-opacity" onclick="window.closeModal()">
                <div class="bg-gray-800 p-6 rounded-2xl shadow-2xl w-full max-w-lg transform transition-all duration-300" onclick="event.stopPropagation()">
                    <div id="modal-content-area">
                        <!-- Content loaded by showTeamEditor/showFixtureEditor -->
                    </div>
                </div>
            </div>
        `);
    </script>
</body>
</html>
