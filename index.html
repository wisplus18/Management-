<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>E-Football Mobile League</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <style>
        :root {
            --primary-color: #90ff10;
            --secondary-color: #beff6c;
            --danger-red: #ff4d4d;
            --cup-blue: #00BFFF;
            --shield-gold: #ffd700;
            --warn-orange: #f59e0b;
            
            --bg-main: #181818; 
            --bg-light: #222222; 
            --bg-lighter: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #aaaaaa;
            --border-color: #3a3a3a;
            --hero-bg-url: url('stadium.jpg'); 
        }

        body[data-theme="light"] {
            --bg-main: #f0f2f5;
            --bg-light: #ffffff;
            --bg-lighter: #f8f9fa;
            --text-primary: #181818;
            --text-secondary: #555555;
            --border-color: #dee2e6;
            --primary-color: #008f5a; 
            --secondary-color: #00b371;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
            min-height: 100vh;
            padding-bottom: 70px;
        }

        /* --- PREDICTION ENGINE STYLES (Restored from predictor.html) --- */
        .pred-box { background: var(--bg-lighter); border: 1px solid var(--border-color); border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .pred-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-top: 10px; }
        .pred-card { background: var(--bg-main); padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); display: flex; flex-direction: column; justify-content: center; text-align: center; }
        .pred-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .pred-val { font-size: 16px; font-weight: 700; color: var(--text-primary); }
        .pred-pill { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; margin: 2px; }
        .pill-good { color: var(--primary-color); border: 1px solid var(--primary-color); background: rgba(144, 255, 16, 0.1); }
        .pill-warn { color: var(--warn-orange); border: 1px solid var(--warn-orange); background: rgba(245, 158, 11, 0.1); }
        .pill-bad { color: var(--danger-red); border: 1px solid var(--danger-red); background: rgba(239, 68, 68, 0.1); }
        .analysis-text { font-family: monospace; font-size: 0.9rem; background: var(--bg-main); padding: 10px; border-radius: 5px; color: var(--text-secondary); border-left: 3px solid var(--primary-color); white-space: pre-wrap; }
        /* ---------------------------------- */

        .custom-navbar {
            background-color: var(--bg-light);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: 0.5rem 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            overflow-x: auto;
            white-space: nowrap;
        }

        .custom-nav-container { display: flex; justify-content: flex-start; align-items: center; padding: 0 15px; gap: 15px; }
        .custom-nav-brand { font-size: 1.2rem; font-weight: 900; color: var(--primary-color); margin-right: 20px; display: flex; align-items: center; text-decoration: none; }
        .custom-nav-links { display: flex; gap: 10px; }
        .custom-nav-item { color: var(--text-secondary); font-weight: 500; text-decoration: none; padding: 8px 12px; border-radius: 20px; transition: all 0.3s; font-size: 0.9rem; text-transform: uppercase; display: flex; align-items: center; gap: 5px; }
        .custom-nav-item:hover, .custom-nav-item.active { background-color: rgba(144, 255, 16, 0.1); color: var(--primary-color); }

        .nav-pills .nav-link { color: var(--text-secondary); background-color: var(--bg-lighter); margin-right: 10px; border: 1px solid var(--border-color); }
        .nav-pills .nav-link.active { background-color: var(--primary-color); color: var(--bg-main); font-weight: 700; }
        .tab-content { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .warning-box { background: rgba(220, 53, 69, 0.1); border: 1px solid var(--danger-red); color: #ff6b6b; padding: 10px; border-radius: 8px; font-size: 0.85rem; margin-bottom: 15px; text-align: center; }
        .info-box { background: rgba(144, 255, 16, 0.1); border: 1px solid var(--primary-color); color: var(--text-primary); padding: 15px; border-radius: 8px; font-size: 0.9rem; margin-bottom: 15px; }
        .hero { background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.8)), var(--hero-bg-url); background-size: cover; background-position: center; color: white; text-align: center; padding: 60px 20px; border-bottom: 2px solid var(--primary-color); }
        .hero h1 { font-size: 2.5rem; font-weight: 900; text-transform: uppercase; }
        .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); color: var(--bg-main); font-weight: 700; }
        .btn-primary:hover { background-color: var(--secondary-color); border-color: var(--secondary-color); }
        section { padding: 40px 0; }
        section:nth-of-type(odd) { background-color: var(--bg-light); }
        .section-title { color: var(--primary-color); font-weight: 700; font-size: 1.8rem; margin-bottom: 20px; text-transform: uppercase; text-align: center; }
        .card { background-color: var(--bg-light); border: 1px solid var(--border-color); color: var(--text-primary); }
        .league-table { background-color: var(--bg-light); color: var(--text-primary); }
        .league-table thead th { background-color: var(--bg-lighter); color: var(--primary-color); border-bottom: 2px solid var(--primary-color); }
        .league-table td { border-bottom-color: var(--border-color); vertical-align: middle; }
        .form-bubble { display: inline-block; width: 20px; height: 20px; line-height: 20px; text-align: center; border-radius: 50%; font-size: 0.7rem; color: #fff; margin: 0 1px; }
        .form-bubble-W { background-color: #28a745; }
        .form-bubble-D { background-color: #6c757d; }
        .form-bubble-L { background-color: #dc3545; }

        .match-card, .result-card { background-color: var(--bg-lighter); border: none; border-radius: 25px; padding: 1rem; margin-bottom: 1rem; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative; overflow: hidden; }
        .match-type-league { border-left: 8px solid var(--primary-color); background: linear-gradient(90deg, rgba(40,167,69,0.05) 0%, rgba(0,0,0,0) 100%); }
        .match-type-cup { border-left: 8px solid var(--cup-blue); background: linear-gradient(90deg, rgba(0,191,255,0.05) 0%, rgba(0,0,0,0) 100%); }
        .match-type-shield { border-left: 8px solid var(--danger-red); background: linear-gradient(90deg, rgba(255,77,77,0.05) 0%, rgba(0,0,0,0) 100%); }
        .match-player img, .result-player img { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; margin: 0 5px; border: 2px solid var(--border-color); }
        .match-player, .result-player { display: flex; align-items: center; }
        .match-player { max-width: 40%; } .result-player { max-width: 30%; }
        .contact-btn { width: 28px; height: 28px; border-radius: 50%; display: inline-flex; justify-content: center; align-items: center; margin: 0 3px; color: white; text-decoration: none; font-size: 0.8rem; flex-shrink: 0; }
        .btn-wa { background-color: #25D366; } .btn-call { background-color: #007bff; }
        .admin-mode, .sub-admin-mode { display: none; }

        @media (max-width: 768px) {
            .match-card, .result-card { gap: 0.5rem; padding: 0.8rem; flex-wrap: wrap; justify-content: space-between; }
            .match-card > div:last-child, .result-card > div:last-child { width: 100%; text-align: center; margin-top: 5px; order: 4; }
            .match-player, .result-player { flex-direction: row; width: auto; justify-content: flex-start; max-width: 45%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.9rem; }
            .result-card .result-player:nth-child(3) { justify-content: flex-end; }
            .match-player img, .result-player img { width: 25px; height: 25px; }
        }
    </style>
</head>
<body>

    <div class="toast-container position-fixed top-0 end-0 p-3" id="toast-container" style="z-index: 1100;"></div>

    <nav class="custom-navbar">
        <div class="custom-nav-container">
            <a href="#" class="custom-nav-brand"><i class="fa-solid fa-futbol me-2"></i> EFLüéÆ</a>
            <div class="custom-nav-links">
                <a href="#league-section" class="custom-nav-item"><i class="fa-solid fa-table-list"></i> League</a>
                <a href="#cup" class="custom-nav-item"><i class="fa-solid fa-trophy"></i> Cup</a>
                <a href="#communityShield" class="custom-nav-item"><i class="fa-solid fa-shield-halved"></i> Shield</a>
                <a href="#players" class="custom-nav-item"><i class="fa-solid fa-users"></i> Players</a>
                <a href="#trophyRoom" class="custom-nav-item"><i class="fa-solid fa-award"></i> History</a>
                <button class="btn btn-sm btn-outline-light ms-2" id="theme-toggle"><i class="fa-solid fa-sun"></i></button>
                <button class="btn btn-sm btn-outline-primary ms-2" id="admin-login-button"><i class="fa-solid fa-lock"></i></button>
                <div class="admin-mode">
                    <button class="btn btn-sm btn-outline-danger ms-2 position-relative" onclick="showPendingModal()">
                        <i class="fa-solid fa-inbox"></i> Pending
                        <span id="pendingCountBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display:none">0</span>
                    </button>
                </div>
                <button class="btn btn-sm btn-outline-secondary ms-2 admin-mode" id="view-activity-log-btn" onclick="showActivityLogModal()"><i class="fa-solid fa-eye-slash"></i> Log</button>
            </div>
        </div>
    </nav>

    <div class="live-ticker" id="liveTicker" style="background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); color: var(--bg-main); padding: 5px; font-weight: 700; white-space: nowrap; overflow: hidden;">
        <span class="live-ticker-content" style="display: inline-block; animation: tickerSlide 35s linear infinite;">Loading...</span>
    </div>
    <style>@keyframes tickerSlide { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }</style>

    <section class="hero">
        <div class="container">
            <h1 id="heroTitle">EFOOTBALL LEAGUE SEASON 1</h1>
            <div id="seasonTimerContainer" style="display:none;" class="mt-3">
                <div class="badge bg-danger p-2 fs-6">‚ö†Ô∏è SEASON ENDS IN: <span id="seasonTimerDisplay" style="font-family:monospace;">00d 00h 00m</span></div>
            </div>
        </div>
    </section>

    <section id="league-section" class="py-5 fade-in-section">
        <div class="container">
            
            <ul class="nav nav-pills mb-4 justify-content-center" id="pills-tab" role="tablist">
                <li class="nav-item"><button class="nav-link active" id="pills-standings-tab" data-bs-toggle="pill" data-bs-target="#pills-standings"><i class="fa-solid fa-list-ol me-1"></i> Standings</button></li>
                <li class="nav-item"><button class="nav-link" id="pills-fixtures-tab" data-bs-toggle="pill" data-bs-target="#pills-fixtures"><i class="fa-solid fa-calendar-days me-1"></i> Fixtures</button></li>
                <li class="nav-item"><button class="nav-link" id="pills-predictions-tab" data-bs-toggle="pill" data-bs-target="#pills-predictions"><i class="fa-solid fa-brain me-1"></i> Predictions</button></li>
            </ul>

            <div class="tab-content" id="pills-tabContent">
                
                <div class="tab-pane fade show active" id="pills-standings" role="tabpanel">
                    <div class="card p-0 mb-4 border-0">
                        <div class="table-responsive">
                            <table class="table league-table table-striped mb-0">
                                <thead><tr><th>#</th> <th>Player</th> <th>MP</th> <th>W</th> <th>D</th> <th>L</th> <th>GF</th> <th>GA</th> <th>GD</th> <th>Form</th> <th>Pts</th></tr></thead>
                                <tbody id="standingsTable"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="admin-mode text-center">
                        <button class="btn btn-sm btn-primary m-1" onclick="showAddPlayerModal()">Add Player</button>
                        <button class="btn btn-sm btn-info m-1 text-white" onclick="showEditBackgroundModal()">BG</button>
                        <button class="btn btn-sm btn-secondary m-1" onclick="showSetSubAdminModal()">Sub-Admin</button>
                        <button class="btn btn-sm btn-warning m-1" onclick="showTimerModal()">Set Timer</button>
                        <button class="btn btn-sm btn-danger m-1" onclick="endSeasonManual()">End Season</button>
                    </div>
                </div>

                <div class="tab-pane fade" id="pills-fixtures" role="tabpanel">
                    <div class="warning-box"><i class="fa-solid fa-triangle-exclamation"></i> <strong>WARNING:</strong> Matches not played by midnight are auto-recorded as <strong>3-0 losses</strong>.</div>
                    <div class="d-flex justify-content-center align-items-center gap-3 mb-3">
                        <button class="btn btn-sm btn-primary" onclick="changeMatchday(-1)"><i class="fa-solid fa-arrow-left"></i></button>
                        <h4 id="currentMatchday" class="m-0">Matchday 1</h4>
                        <button class="btn btn-sm btn-primary" onclick="changeMatchday(1)"><i class="fa-solid fa-arrow-right"></i></button>
                    </div>
                    <div class="text-center text-muted small mb-3" id="matchdayDateDisplay"></div>
                    <div id="fixturesContainer"></div>
                    <div class="admin-mode mt-4 text-center">
                        <button class="btn btn-primary m-1" onclick="showAddFixtureModal()">Add Fixture</button>
                        <button class="btn btn-info m-1 text-white" onclick="openGenerateModal()">Auto-Generate Season</button>
                        <button class="btn btn-danger m-1" onclick="forceAutoForfeits()">Force Auto-Resolve</button>
                    </div>
                </div>

                <div class="tab-pane fade" id="pills-predictions" role="tabpanel">
                    
                    <div class="admin-mode mb-4">
                        <div class="pred-box border-warning" style="border-width: 2px;">
                            <h4 class="text-warning"><i class="fa-solid fa-calculator"></i> Advanced Prediction Engine</h4>
                            <div class="mb-3 p-2 border rounded bg-dark">
                                <label class="text-muted small">Import External League JSON (Optional)</label>
                                <input type="file" id="externalJsonFile" accept="application/json" class="form-control form-control-sm bg-secondary text-white border-0">
                                <div class="small text-muted mt-1">If file is selected, engine uses external data. If not, uses app data.</div>
                            </div>
                            <div class="row g-2 mb-3">
                                <div class="col-6"><select id="predTeamA" class="form-select"><option value="">Team A</option></select></div>
                                <div class="col-6"><select id="predTeamB" class="form-select"><option value="">Team B</option></select></div>
                            </div>
                            <button class="btn btn-primary w-100" onclick="generateAdminPrediction()">Generate Full Prediction</button>
                            
                            <div id="predAdminOutput" class="mt-3 d-none">
                                <div class="pred-grid">
                                    <div class="pred-card">
                                        <div class="pred-label">Expected Goals</div>
                                        <div class="pred-val" id="predXg"></div>
                                    </div>
                                    <div class="pred-card">
                                        <div class="pred-label">Risk Level</div>
                                        <div class="pred-val" id="predRisk"></div>
                                    </div>
                                    <div class="pred-card">
                                        <div class="pred-label">Confidence</div>
                                        <div class="pred-val" id="predConf"></div>
                                    </div>
                                    <div class="pred-card">
                                        <div class="pred-label">BTTS %</div>
                                        <div class="pred-val" id="predBTTS"></div>
                                    </div>
                                </div>

                                <div class="pred-box mt-2">
                                    <div class="pred-label">1X2 Probabilities</div>
                                    <div id="predOdds" class="mb-2"></div>
                                    <div class="pred-label mt-2">Bookmaker Odds (Decimal)</div>
                                    <div id="predBook" class="text-white fw-bold small"></div>
                                </div>

                                <div class="pred-grid">
                                    <div class="pred-card">
                                        <div class="pred-label">Over/Under</div>
                                        <div class="small text-start ps-3" id="predOU"></div>
                                    </div>
                                    <div class="pred-card">
                                        <div class="pred-label">Correct Scores</div>
                                        <div class="small fw-bold" id="predCS"></div>
                                    </div>
                                </div>

                                <textarea id="predAnalysisInput" class="form-control mb-2 mt-3" rows="4" placeholder="Analysis text..."></textarea>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="autoText()">Auto-Generate Text</button>
                                    <button class="btn btn-sm btn-outline-info" onclick="exportAnalysisText()">Export Text</button>
                                    <button class="btn btn-sm btn-success flex-grow-1" onclick="publishPrediction()">Publish</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h5 class="section-title text-start fs-5 mb-3"><i class="fa-solid fa-bullhorn"></i> Pundit's Corner</h5>
                    <div id="predictionsList"></div>

                </div>
            </div>
        </div>
    </section>
    
    <section id="cup" class="py-5 bg-light fade-in-section">
        <div class="container">
            <h2 class="section-title text-danger"><i class="fa-solid fa-trophy me-2"></i> FA Cup</h2>
            <ul class="nav nav-pills mb-4 justify-content-center" id="cup-tabs">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#cup-about">About FA Cup</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#cup-fixtures">Fixtures</button></li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane fade show active" id="cup-about">
                    <div class="info-box border-primary">
                        <h5 class="fw-bold mb-3">Masharti na Vigezo (FA Cup Rules)</h5>
                        <ul class="list-unstyled"><li class="mb-2">üëâ <strong>One game knockout</strong>.</li><li class="mb-2">üëâ <strong>Defeat = Exit</strong>.</li></ul>
                    </div>
                </div>
                <div class="nav-panes tab-pane fade" id="cup-fixtures">
                    <div class="d-flex justify-content-center align-items-center gap-3 mb-3">
                        <button class="btn btn-primary" onclick="changeCupRound(-1)"><i class="fa-solid fa-arrow-left"></i></button>
                        <h4 id="cupRoundName" class="m-0">Cup Fixtures</h4>
                        <button class="btn btn-primary" onclick="changeCupRound(1)"><i class="fa-solid fa-arrow-right"></i></button>
                    </div>
                    <div id="cupContainer" class="row g-4"></div>
                    <div class="admin-mode mt-4 text-center">
                        <button class="btn btn-danger m-1" onclick="generateCup()">Generate Cup</button>
                        <button class="btn btn-success m-1" onclick="generateNextCupRound()">Next Round</button>
                        <button class="btn btn-warning m-1" onclick="showSetCupImageModal()">Set Cup Image</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="communityShield" class="py-5 fade-in-section">
        <div class="container">
            <h2 class="section-title text-warning"><i class="fa-solid fa-shield-halved me-2"></i> Community Shield</h2>
            <ul class="nav nav-pills mb-4 justify-content-center" id="shield-tabs">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#shield-about">About Shield</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#shield-match">The Match</button></li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane fade show active" id="shield-about">
                    <div class="info-box border-warning" style="background: rgba(255, 215, 0, 0.05);">
                        <h5 class="fw-bold mb-3 text-warning">About Community Shield</h5>
                        <ul class="list-unstyled"><li class="mb-2">üëâ <strong>The Big Game:</strong> League Winner vs Cup Winner.</li></ul>
                    </div>
                </div>
                <div class="nav-panes tab-pane fade" id="shield-match">
                    <div id="shieldMatchContainer" class="row justify-content-center"></div>
                    <div class="admin-mode mt-4 text-center"><button class="btn btn-warning" onclick="showSetShieldModal()">Set Shield Match</button></div>
                </div>
            </div>
        </div>
    </section>

    <section id="players" class="py-5 bg-light fade-in-section"><div class="container"><h2 class="section-title">Players & Stats</h2><div class="row row-cols-2 row-cols-md-4 g-4" id="playersContainer"></div></div></section>

    <section id="trophyRoom" class="py-5 fade-in-section">
        <div class="container">
            <h2 class="section-title text-warning"><i class="fa-solid fa-award"></i> History</h2>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="trophy-nav" id="trophySeasonTabs"></div>
                <div class="admin-mode">
                    <button class="btn btn-sm btn-outline-success" onclick="exportData()"><i class="fa-solid fa-file-export"></i> Export All Data</button>
                    <label class="btn btn-sm btn-outline-primary ms-1" style="cursor: pointer;">
                        <i class="fa-solid fa-file-import"></i> Import All Data <input type="file" id="importJsonInput" style="display: none;" onchange="importData(this)">
                    </label>
                </div>
            </div>
            <div id="trophyContainer"><p class="text-center text-secondary">No history selected or available.</p></div>
        </div>
    </section>

    <div class="modal fade" id="adminModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Admin Login</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="password" id="adminPassword" class="form-control" placeholder="Enter Password"></div><div class="modal-footer"><button class="btn btn-primary" onclick="loginAdmin()">Login</button></div></div></div></div>
    <div class="modal fade" id="timerModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Set Season End Timer</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="row"><div class="col"><input type="number" id="timerDays" class="form-control" placeholder="Days" min="0"></div><div class="col"><input type="number" id="timerHours" class="form-control" placeholder="Hours" min="0"></div><div class="col"><input type="number" id="timerMinutes" class="form-control" placeholder="Mins" min="0"></div></div></div><div class="modal-footer"><button class="btn btn-danger" onclick="clearTimer()">Clear</button><button class="btn btn-primary" onclick="setTimer()">Start</button></div></div></div></div>
    <div class="modal fade" id="resultModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Enter Result (Admin)</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><input type="hidden" id="resultMatchId"><input type="hidden" id="resultMatchType"><div class="d-flex justify-content-center align-items-center gap-2"><label id="resultPlayer1Name">P1</label><input type="number" id="resultScore1" class="form-control w-25 text-center"><span class="fw-bold">VS</span><input type="number" id="resultScore2" class="form-control w-25 text-center"><label id="resultPlayer2Name">P2</label></div></div><div class="modal-footer"><button class="btn btn-primary" onclick="submitResult()">Submit</button></div></div></div></div>
    <div class="modal fade" id="generateLeagueModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Generate League Fixtures</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><p>Choose League Format:</p><button class="btn btn-primary w-100 mb-2" onclick="generateFixtures('double')">Double Round (Home & Away)</button><button class="btn btn-secondary w-100" onclick="generateFixtures('single')">Single Round (Once vs Each)</button></div></div></div></div>
    <div class="modal fade" id="playerSubmitModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Submit Result</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><input type="hidden" id="ps_fixtureId"><div class="mb-2 text-start"><small class="text-muted">Confirm teams (Select your team):</small></div><select id="ps_homeSelect" class="form-select mb-2"></select><select id="ps_awaySelect" class="form-select mb-2"></select><div class="d-flex justify-content-center gap-2"><input type="number" id="ps_score1" class="form-control w-25 text-center" placeholder="0"><span class="fw-bold align-self-center">VS</span><input type="number" id="ps_score2" class="form-control w-25 text-center" placeholder="0"></div><div class="small text-muted mt-2">Opponent has 6 hours to dispute.</div></div><div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button class="btn btn-primary" onclick="submitPlayerResult()">Submit Result</button></div></div></div></div>
    <div class="modal fade" id="pendingModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Pending Results (Admin)</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="d-flex justify-content-end mb-2"><button class="btn btn-success fw-bold" onclick="approveAllPending()"><i class="fa-solid fa-check-double"></i> APPROVE ALL</button></div><div id="pendingListContent" style="max-height: 50vh; overflow-y: auto;"></div></div><div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div></div></div></div>
    <div class="modal fade" id="sessionTeamModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Welcome! Select Your Team</h5></div><div class="modal-body text-center"><p class="text-muted">To submit results for this session, please select which team you are managing.</p><select id="sessionTeamSelect" class="form-select mb-3"><option value="">-- Choose Team --</option></select><button class="btn btn-primary w-100 mb-2" onclick="setSessionTeam()">Select Team</button><button class="btn btn-outline-secondary w-100" onclick="skipSessionTeam()">Skip (View Only)</button></div></div></div></div>
    <div class="modal fade" id="addPlayerModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Add Player</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="text" id="playerName" class="form-control mb-2" placeholder="Name"><input type="url" id="playerAvatarUrl" class="form-control mb-2" placeholder="Avatar URL"><input type="url" id="playerSocialLink" class="form-control mb-2" placeholder="WhatsApp Link"><input type="tel" id="playerPhone" class="form-control" placeholder="Phone Number"></div><div class="modal-footer"><button class="btn btn-primary" onclick="submitPlayer()">Add</button></div></div></div></div>
    <div class="modal fade" id="editBackgroundModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Background</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="url" id="backgroundUrl" class="form-control" placeholder="Image URL"></div><div class="modal-footer"><button class="btn btn-primary" onclick="submitBackground()">Save</button></div></div></div></div>
    <div class="modal fade" id="setShieldModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Shield Match</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><select id="shieldPlayer1" class="form-select mb-2"></select><select id="shieldPlayer2" class="form-select mb-2"></select><input type="date" id="shieldDate" class="form-control mb-2"><input type="url" id="shieldImageUrl" class="form-control" placeholder="Image URL"></div><div class="modal-footer"><button class="btn btn-primary" onclick="submitShieldMatch()">Set</button></div></div></div></div>
    <div class="modal fade" id="addFixtureModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Add Fixture</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><select id="fixturePlayer1" class="form-select mb-2"></select><select id="fixturePlayer2" class="form-select mb-2"></select><input type="date" id="fixtureDate" class="form-control mb-2"><input type="number" id="fixtureMatchday" class="form-control" placeholder="Matchday" value="1"></div><div class="modal-footer"><button class="btn btn-primary" onclick="submitFixture()">Add</button></div></div></div></div>
    <div class="modal fade" id="setCupImageModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Cup Image</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="url" id="cupImageUrlInput" class="form-control" placeholder="URL"></div><div class="modal-footer"><button class="btn btn-primary" onclick="submitCupImage()">Save</button></div></div></div></div>
    <div class="modal fade" id="subAdminModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Sub Admin</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><select id="subAdminPlayerSelect" class="form-select mb-2"></select><input type="password" id="subAdminPasswordInput" class="form-control" placeholder="Password"></div><div class="modal-footer"><button class="btn btn-danger" onclick="removeSubAdmin()">Remove</button><button class="btn btn-primary" onclick="setSubAdmin()">Set</button></div></div></div></div>
    <div class="modal fade" id="activityLogModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Shadow Activity Log</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="activityLogContent" style="max-height:60vh; overflow:auto;"></div><div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCLycBxpQ3MMIDLYjmBqMZv32FIu2eDXF4", authDomain: "efootball-app-ce90b.firebaseapp.com", projectId: "efootball-app-ce90b", storageBucket: "efootball-app-ce90b.firebasestorage.app", messagingSenderId: "387933114333", appId: "1:387933114333:web:1c85dbadacf70d0406b034" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let password = "Genie";

        // APP STATE
        let leagueData = { seasonNumber: 1, seasonEndTime: null, seasonHistory: [], players: [], fixtures: [], results: [], predictions: [], backgroundUrl: 'url("stadium.jpg")', cupFixtures: [], shieldMatch: null, cupImageUrl: '', subAdminPlayerId: null, subAdminPassword: '', resultsPending: [], activityLog: [] };
        let currentMatchday = 1, totalMatchdays = 1, cupRounds = [], currentCupRoundIndex = 0, isAdmin = false, isSubAdmin = false, timerInterval, sessionTeamId = null;
        let externalLeagueData = null; // Store external imported JSON here
        let currentPrediction = null; // Temp store
        const defaultAvatar = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' fill='%236c757d'%3E%3Cpath d='M50,0A50,50,0,1,0,50,100,50,50,0,0,0,50,0ZM76.4,26.66l-6.85,6.85a28,28,0,0,1-13.7,11.37L50,50,44.15,44.88a28,28,0,0,1-11.37-13.7L25.93,23.6A38.56,38.56,0,0,1,50,11.5a38.16,38.16,0,0,1,26.4,15.16ZM23.6,74.07l6.85-6.85a28,28,0,0,1,13.7-11.37L50,50,55.85,55.12a28,28,0,0,1,11.37,13.7l6.85,6.85A38.56,38.56,0,0,1,50,88.5,38.16,38.16,0,0,1,23.6,74.07Z'/%3E%3C/svg%3E";

        document.addEventListener('DOMContentLoaded', () => {
            const themeToggle = document.getElementById('theme-toggle');
            themeToggle.addEventListener('click', () => {
                const current = document.body.getAttribute('data-theme');
                const next = current === 'dark' ? 'light' : 'dark';
                document.body.setAttribute('data-theme', next);
                themeToggle.innerHTML = next === 'dark' ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
                localStorage.setItem('theme', next);
            });
            document.body.setAttribute('data-theme', localStorage.getItem('theme') || 'dark');
            document.getElementById('admin-login-button').addEventListener('click', () => new bootstrap.Modal(document.getElementById('adminModal')).show());
            
            // External File Input Listener
            document.getElementById('externalJsonFile').addEventListener('change', (e) => {
                const f = e.target.files[0]; if(!f) return;
                const r = new FileReader();
                r.onload = () => { 
                    try {
                        const json = JSON.parse(r.result);
                        externalLeagueData = { players: json.players || [], results: json.results || [] };
                        buildExternalTeams(externalLeagueData);
                        showToast("External Data Loaded", "info");
                    } catch(err) { showToast("Invalid JSON", "danger"); }
                };
                r.readAsText(f);
            });

            loadData();
            setInterval(checkPendingTimeouts, 30 * 1000); 
        });

        async function loadData() {
            try {
                const doc = await db.collection('league').doc('data').get();
                if (doc.exists) {
                    leagueData = { ...leagueData, ...doc.data() };
                    leagueData.predictions = leagueData.predictions || [];
                } else await saveData(false);
                applyBackground(); calculateTotalMatchdays(); calculateCupRounds(); autoResolveExpiredMatches(); updateViews(); checkSeasonTimer(); promptSessionTeamSelection(); populatePredictionSelects();
            } catch (error) { console.error(error); showToast("Data Load Error", "danger"); }
        }

        async function saveData(toast = true) {
            try { await db.collection('league').doc('data').set(leagueData); if(toast) showToast('Saved!', 'success'); } catch (error) { console.error(error); showToast('Save Error', 'danger'); }
        }

        function updateViews() {
            document.getElementById('heroTitle').innerText = `EFOOTBALL LEAGUE SEASON ${leagueData.seasonNumber}`;
            updateStandings(); renderLeagueMatches(); renderCupMatches(); renderShieldMatch(); renderTrophyRoomButtons(); updatePlayers(); updateLiveTicker(); updatePendingCount(); renderPredictionsList();
            const display = isAdmin ? 'block' : 'none';
            document.querySelectorAll('.admin-mode').forEach(el => el.style.display = display);
            if(isAdmin || isSubAdmin) document.querySelectorAll('.sub-admin-mode').forEach(el => el.style.display = 'block');
        }

        // --- PREDICTION ENGINE LOGIC ---
        function populatePredictionSelects() {
            // By default use App data. If external loaded, it will have repopulated this via buildExternalTeams
            if(!externalLeagueData) {
                const a = document.getElementById('predTeamA'), b = document.getElementById('predTeamB');
                a.innerHTML='<option value="">Team A</option>'; b.innerHTML='<option value="">Team B</option>';
                leagueData.players.filter(p=>p.eligible).forEach(p => { 
                    const o = document.createElement('option'); o.value = p.id; o.textContent = p.name;
                    a.appendChild(o); b.appendChild(o.cloneNode(true));
                });
            }
        }

        function buildExternalTeams(data) {
            // Logic to calculate stats from raw external JSON results
            // Assumes structure { players: [{id, name}], results: [{homeId, awayId, homeScore, awayScore}] }
            const teams = {};
            data.players.forEach(p => teams[p.id] = { ...p, mp:0, gf:0, ga:0, pts:0, form:[] });
            data.results.forEach(m => {
                const A = teams[m.homeId || m.player1Id], B = teams[m.awayId || m.player2Id];
                if(!A || !B) return;
                const hs = m.homeScore || m.score1, as = m.awayScore || m.score2;
                A.mp++; B.mp++; A.gf+=hs; A.ga+=as; B.gf+=as; B.ga+=hs;
                if(hs>as){A.pts+=3;A.form.push(3);B.form.push(0)} else if(hs<as){B.pts+=3;B.form.push(3);A.form.push(0)} else{A.pts+=1;B.pts+=1;A.form.push(1);B.form.push(1)}
            });
            externalLeagueData.calculatedTeams = teams;
            const a = document.getElementById('predTeamA'), b = document.getElementById('predTeamB');
            a.innerHTML='<option value="">Team A</option>'; b.innerHTML='<option value="">Team B</option>';
            Object.values(teams).forEach(t => { 
                const o = document.createElement('option'); o.value = t.id; o.textContent = t.name;
                a.appendChild(o); b.appendChild(o.cloneNode(true));
            });
        }

        const avg=(n,d)=>d?n/d:0; const clamp=(x,min,max)=>Math.min(max,Math.max(min,x));

        function generateAdminPrediction() {
            const idA = document.getElementById('predTeamA').value, idB = document.getElementById('predTeamB').value;
            if(!idA || !idB || idA === idB) return showToast('Pick two different teams', 'warning');

            let A, B;
            if (externalLeagueData) {
                // Use external calculated data
                A = externalLeagueData.calculatedTeams[idA]; B = externalLeagueData.calculatedTeams[idB];
                // Normalize form array to W/D/L for compatibility if needed, but we used 3/1/0 in buildExternalTeams
            } else {
                // Use internal live app data
                // Need to convert 'W','D','L' form to numbers
                A = leagueData.players.find(p => p.id === idA); B = leagueData.players.find(p => p.id === idB);
            }

            // Stats Calculation
            const aGF=avg(A.gf,A.mp), aGA=avg(A.ga,A.mp), bGF=avg(B.gf,B.mp), bGA=avg(B.ga,B.mp);
            const xgA=( (aGF+bGA)/2 ), xgB=( (bGF+aGA)/2 );

            // Strength / Form Logic
            const formCalc = (arr) => {
                if(!arr) return 0;
                // If internal data (W,D,L strings)
                if(typeof arr[0] === 'string') return arr.slice(0,5).reduce((s,r)=>s+(r==='W'?3:r==='D'?1:0),0)/15;
                // If external data (3,1,0 numbers)
                return arr.slice(-5).reduce((a,b)=>a+b,0)/15;
            };
            
            const sA=avg(A.pts,A.mp)+(A.gf-A.ga)/Math.max(1,A.mp) + formCalc(A.form);
            const sB=avg(B.pts,B.mp)+(B.gf-B.ga)/Math.max(1,B.mp) + formCalc(B.form);

            // Probabilities
            let pA=sA/(sA+sB), pB=sB/(sA+sB); let pD=0.22; pA*=0.78; pB*=0.78;
            const norm=pA+pB+pD; pA/=norm; pB/=norm; pD/=norm;

            // Odds
            const margin=0.06;
            const oA=(1/((pA*(1-margin)))) , oD=(1/((pD*(1-margin)))) , oB=(1/((pB*(1-margin))));

            // Over/Under & BTTS
            const tot=xgA+xgB;
            const pOver15 = clamp((tot-1.0)/2.5,0,1);
            const pOver25 = clamp((tot-2.0)/2.5,0,1);
            const pOver35 = clamp((tot-3.0)/2.5,0,1);
            const pBTTS = clamp(((xgA+xgB)/3),0,1);

            // Correct Scores
            const cs=[`${Math.round(xgA)}-${Math.round(xgB)}`, `${Math.max(0,Math.round(xgA)-1)}-${Math.round(xgB)}`];

            // Confidence & Risk
            const conf=clamp(Math.abs(pA-pB)*100+20,35,85);
            const riskIndex = clamp(100-conf,15,75);

            // --- RENDER ADMIN UI ---
            document.getElementById('predXg').textContent = `${A.name} ${xgA.toFixed(2)} : ${xgB.toFixed(2)} ${B.name}`;
            document.getElementById('predRisk').innerHTML = `<span class="badge ${riskIndex>60?'bg-danger':riskIndex>40?'bg-warning':'bg-success'}">${riskIndex.toFixed(0)}</span>`;
            document.getElementById('predConf').textContent = conf.toFixed(0)+'%';
            document.getElementById('predBTTS').textContent = (pBTTS*100).toFixed(0)+'%';
            
            document.getElementById('predOdds').innerHTML = 
                `<span class='pred-pill pill-good'>${A.name} ${(pA*100).toFixed(0)}%</span>` +
                `<span class='pred-pill pill-warn'>Draw ${(pD*100).toFixed(0)}%</span>` +
                `<span class='pred-pill pill-bad'>${B.name} ${(pB*100).toFixed(0)}%</span>`;
            
            document.getElementById('predBook').textContent = `Odds: ${oA.toFixed(2)} | ${oD.toFixed(2)} | ${oB.toFixed(2)}`;

            document.getElementById('predOU').innerHTML = 
                `> 1.5: ${(pOver15*100).toFixed(0)}% | > 2.5: ${(pOver25*100).toFixed(0)}% | > 3.5: ${(pOver35*100).toFixed(0)}%`;
            
            document.getElementById('predCS').textContent = cs.join(', ');

            // Store Temp
            currentPrediction = {
                id: Date.now().toString(),
                teamA: A.name, teamB: B.name, teamAId: A.id, teamBId: B.id,
                xgA: xgA.toFixed(2), xgB: xgB.toFixed(2),
                probA: (pA*100).toFixed(0), probD: (pD*100).toFixed(0), probB: (pB*100).toFixed(0),
                risk: riskIndex.toFixed(0), conf: conf.toFixed(0), btts: (pBTTS*100).toFixed(0),
                timestamp: Date.now()
            };

            autoText(); 
            document.getElementById('predAdminOutput').classList.remove('d-none');
        }

        function autoText() {
            if(!currentPrediction) return;
            // Access team names safely
            const tA = currentPrediction.teamA, tB = currentPrediction.teamB;
            
            let txt = `Mechi kali: ${tA} vs ${tB}. `;
            if(parseInt(currentPrediction.probA) > 50) txt += `${tA} wana nafasi kubwa ya kushinda (${currentPrediction.probA}%). `;
            else if(parseInt(currentPrediction.probB) > 50) txt += `${tB} wanaonekana vizuri ugenini. `;
            else txt += `Hii game ni tight, sare inawezekana sana. `;
            
            txt += `Tunategemea ${parseInt(currentPrediction.btts) > 55 ? "timu zote kufunga (BTTS)" : "defense kuwa ngumu"}. `;
            txt += `Risk Level ni ${currentPrediction.risk}/100.`;
            
            document.getElementById('predAnalysisInput').value = txt;
        }

        async function publishPrediction() {
            if(!currentPrediction) return;
            currentPrediction.analysis = document.getElementById('predAnalysisInput').value;
            leagueData.predictions.unshift(currentPrediction);
            if(leagueData.predictions.length > 20) leagueData.predictions.pop();
            await saveData();
            document.getElementById('predAdminOutput').classList.add('d-none');
            updateViews();
        }

        function exportAnalysisText() {
            const txt = document.getElementById('predAnalysisInput').value;
            const blob = new Blob([txt],{type:'text/plain'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='prediction.txt'; a.click();
        }

        function renderPredictionsList() {
            const list = document.getElementById('predictionsList');
            list.innerHTML = '';
            if(!leagueData.predictions || leagueData.predictions.length === 0) { list.innerHTML = '<p class="text-muted text-center">No predictions yet.</p>'; return; }
            leagueData.predictions.forEach(p => {
                const date = new Date(p.timestamp).toLocaleDateString();
                list.innerHTML += `
                <div class="pred-box">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="m-0 fw-bold text-white">${p.teamA} vs ${p.teamB}</h5>
                        <small class="text-muted">${date}</small>
                    </div>
                    <div class="d-flex gap-2 mb-2 justify-content-center">
                        <span class="badge bg-secondary">Risk: ${p.risk}</span>
                        <span class="badge bg-secondary">Conf: ${p.conf}%</span>
                        <span class="badge bg-secondary">BTTS: ${p.btts}%</span>
                    </div>
                    <div class="pred-grid mb-2">
                        <div class="pred-card"><div class="pred-label">Win ${p.teamA}</div><div class="text-success fw-bold">${p.probA}%</div></div>
                        <div class="pred-card"><div class="pred-label">Draw</div><div class="text-warning fw-bold">${p.probD}%</div></div>
                        <div class="pred-card"><div class="pred-label">Win ${p.teamB}</div><div class="text-danger fw-bold">${p.probB}%</div></div>
                    </div>
                    <div class="analysis-text">"${p.analysis}"</div>
                    <div class="admin-mode text-end mt-2"><button class="btn btn-sm btn-outline-danger" onclick="deletePrediction('${p.id}')"><i class="fa-solid fa-trash"></i></button></div>
                </div>`;
            });
        }
        async function deletePrediction(id) { if(!confirm("Delete?")) return; leagueData.predictions = leagueData.predictions.filter(p => p.id !== id); await saveData(); updateViews(); }

        // --- EXPORT/IMPORT ALL DATA (Includes Predictions) ---
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(leagueData));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `efootball_backup_S${leagueData.seasonNumber}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
        async function importData(input) {
            if(!isAdmin) { showToast("Admin only", "danger"); return; }
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if(confirm("Overwrite all current data?")) {
                        leagueData = { ...leagueData, ...imported };
                        await saveData(); window.location.reload();
                    }
                } catch(err) { console.error(err); showToast("Error", "danger"); }
            };
            reader.readAsText(file);
        }

        // --- EXISTING STANDARD FUNCTIONS ---
        function updatePendingCount() { const count = leagueData.resultsPending.filter(p => p.status === 'pending').length; const badge = document.getElementById('pendingCountBadge'); badge.innerText = count; badge.style.display = count > 0 ? 'block' : 'none'; }
        function promptSessionTeamSelection() { const eligible = leagueData.players.filter(p => p.eligible); if(eligible.length === 0) return; const modalEl = document.getElementById('sessionTeamModal'); const select = document.getElementById('sessionTeamSelect'); select.innerHTML = '<option value="">-- Choose Team --</option>'; eligible.forEach(p => select.innerHTML += `<option value="${p.id}">${p.name}</option>`); new bootstrap.Modal(modalEl).show(); }
        function setSessionTeam() { const val = document.getElementById('sessionTeamSelect').value; if(!val) return showToast("Select a team", "warning"); sessionTeamId = val; const p = getPlayer(val); showToast(`Welcome back, ${p.name}!`, "success"); bootstrap.Modal.getInstance(document.getElementById('sessionTeamModal')).hide(); updateViews(); }
        function skipSessionTeam() { sessionTeamId = null; bootstrap.Modal.getInstance(document.getElementById('sessionTeamModal')).hide(); }
        async function checkPendingTimeouts() { const now = Date.now(); let changed = false; for(const p of [...leagueData.resultsPending]) { if(p.status === 'pending' && p.expiresAt <= now) { p.status = 'accepted'; applyPendingAsOfficial(p); logActivity(p.submittedByPlayerId, 'auto_accept', `Fixture ${p.fixtureId} auto-accepted.`); changed = true; } } if(changed) { await saveData(false); updateViews(); } }
        function applyPendingAsOfficial(pending) { const fixture = findFixtureById(pending.fixtureId); if(fixture) { fixture.isPlayed = true; if(getFixtureType(pending.fixtureId) !== 'league') { fixture.result = { score1: pending.score1, score2: pending.score2 }; } } leagueData.results = leagueData.results.filter(r => r.fixtureId !== pending.fixtureId); leagueData.results.push({ fixtureId: pending.fixtureId, player1Id: pending.homeId, player2Id: pending.awayId, score1: pending.score1, score2: pending.score2, timestamp: Date.now() }); }
        function getFixtureType(id) { if(leagueData.fixtures.find(f => f.id === id)) return 'league'; if(leagueData.cupFixtures.find(f => f.id === id)) return 'cup'; if(leagueData.shieldMatch && leagueData.shieldMatch.fixture && leagueData.shieldMatch.fixture.id === id) return 'shield'; return 'league'; }
        function showPendingModal() { const container = document.getElementById('pendingListContent'); const pending = leagueData.resultsPending.filter(p => p.status === 'pending'); container.innerHTML = ''; if(pending.length === 0) { container.innerHTML = '<p class="text-center text-muted">No pending results.</p>'; } else { pending.forEach(p => { container.innerHTML += `<div class="card p-2 mb-2"><div class="d-flex justify-content-between align-items-center"><div><strong>${getPlayer(p.homeId).name} ${p.score1} - ${p.score2} ${getPlayer(p.awayId).name}</strong><br><small class="text-muted">Sub: ${getPlayer(p.submittedByPlayerId).name}</small></div><div><button class="btn btn-sm btn-success" onclick="acceptPending('${p.id}', 'admin')"><i class="fa-solid fa-check"></i></button><button class="btn btn-sm btn-danger" onclick="disputePending('${p.id}', 'admin')"><i class="fa-solid fa-times"></i></button></div></div></div>`; }); } new bootstrap.Modal(document.getElementById('pendingModal')).show(); }
        async function approveAllPending() { const pending = leagueData.resultsPending.filter(p => p.status === 'pending'); if(pending.length === 0) return showToast("Nothing to approve.", "info"); if(!confirm(`Approve all ${pending.length}?`)) return; pending.forEach(p => { p.status = 'accepted'; applyPendingAsOfficial(p); }); logActivity('admin', 'approve_all', `Admin approved ${pending.length}`); await saveData(); showToast("Approved!", "success"); updateViews(); bootstrap.Modal.getInstance(document.getElementById('pendingModal')).hide(); }
        async function disputePending(id, uid) { const p = leagueData.resultsPending.find(x => x.id === id); if(!p) return; p.status = 'disputed'; logActivity(uid, 'dispute', `Disputed ${id}`); await saveData(); showToast('Disputed.', 'warning'); updateViews(); if(uid==='admin') showPendingModal(); }
        async function acceptPending(id, uid) { const p = leagueData.resultsPending.find(x => x.id === id); if(!p) return; p.status = 'accepted'; applyPendingAsOfficial(p); logActivity(uid, 'accept', `Accepted ${id}`); await saveData(); showToast('Accepted.', 'success'); updateViews(); if(uid==='admin') showPendingModal(); }
        function findFixtureById(id) { return leagueData.fixtures.find(f => f.id === id) || leagueData.cupFixtures.find(f => f.id === id) || (leagueData.shieldMatch && leagueData.shieldMatch.fixture && leagueData.shieldMatch.fixture.id === id ? leagueData.shieldMatch.fixture : null); }
        async function autoResolveExpiredMatches() { const today = new Date().toISOString().split('T')[0]; let chg = false; leagueData.fixtures.forEach(f => { if(f.date < today && !f.isPlayed) { resolveForfeit(f, 'league'); chg = true; } }); if(chg) { await saveData(false); updateViews(); } }
        function forceAutoForfeits() { if(!isAdmin) return; autoResolveExpiredMatches(); showToast("Done.", "info"); }
        function resolveForfeit(f, t) { const p1 = getPlayer(f.player1Id), p2 = getPlayer(f.player2Id); let s1=0, s2=0; if((p1.penaltyCount||0) > (p2.penaltyCount||0)) { s1=0; s2=3; p1.penaltyCount++; } else if ((p2.penaltyCount||0) > (p1.penaltyCount||0)) { s1=3; s2=0; p2.penaltyCount++; } else { if(Math.random()<0.5){s1=0;s2=3;p1.penaltyCount++}else{s1=3;s2=0;p2.penaltyCount++} } f.isPlayed = true; if(t==='league') { leagueData.results = leagueData.results.filter(r => r.fixtureId !== f.id); leagueData.results.push({ fixtureId: f.id, player1Id: f.player1Id, player2Id: f.player2Id, score1: s1, score2: s2, timestamp: Date.now() }); } }
        function openGenerateModal() { if(!isAdmin) return; new bootstrap.Modal(document.getElementById('generateLeagueModal')).show(); }
        async function generateFixtures(type) { bootstrap.Modal.getInstance(document.getElementById('generateLeagueModal')).hide(); if(!confirm("Generate fixtures? Clears old ones.")) return; leagueData.fixtures = []; leagueData.results = []; leagueData.resultsPending = []; leagueData.players.forEach(p => p.penaltyCount = 0); const players = leagueData.players.filter(p => p.eligible).map(p => p.id); if(players.length < 2) return showToast("Not enough players.", "danger"); if(players.length % 2 !== 0) players.push('BYE'); const n = players.length; const singleRound = n - 1; const rounds = type === 'single' ? singleRound : singleRound * 2; for(let r = 1; r <= rounds; r++) { let offset = r - 1; let d = new Date(); d.setDate(new Date().getDate() + offset); let dStr = d.toISOString().split('T')[0]; for(let i = 0; i < n / 2; i++) { const p1 = players[i], p2 = players[n - 1 - i]; if(p1 !== 'BYE' && p2 !== 'BYE') { let h = p1, a = p2; if(r > singleRound) { h = p2; a = p1; } else if (r % 2 === 1) { h = p2; a = p1; } leagueData.fixtures.push({ id: `${Date.now()}-${r}-${i}`, player1Id: h, player2Id: a, date: dStr, matchday: r, isPlayed: false }); } } players.splice(1, 0, players.pop()); } calculateTotalMatchdays(); await saveData(); updateViews(); }
        function getPlayer(id) { if(id === 'BYE') return { name: 'BYE', avatar: defaultAvatar }; return leagueData.players.find(p => p.id === id) || { name: 'Unknown', avatar: defaultAvatar }; }
        function getContactLinks(p) { if(p.id==='BYE')return''; let h=''; if(p.socialLink) h+=`<a href="${p.socialLink}" target="_blank" class="contact-btn btn-wa"><i class="fa-brands fa-whatsapp"></i></a>`; if(p.phone) h+=`<a href="tel:${p.phone}" class="contact-btn btn-call"><i class="fa-solid fa-phone"></i></a>`; return h; }
        function updateStandings() { leagueData.players.forEach(p => { p.mp=0;p.w=0;p.d=0;p.l=0;p.gf=0;p.ga=0;p.gd=0;p.pts=0;p.form=[]; }); leagueData.results.sort((a,b) => a.timestamp - b.timestamp).forEach(r => { const p1 = leagueData.players.find(p => p.id === r.player1Id), p2 = leagueData.players.find(p => p.id === r.player2Id); if(p1 && p2) { p1.mp++; p2.mp++; p1.gf += r.score1; p1.ga += r.score2; p1.gd = p1.gf - p1.ga; p2.gf += r.score2; p2.ga += r.score1; p2.gd = p2.gf - p2.ga; if(r.score1 > r.score2) { p1.w++; p1.pts+=3; p1.form.unshift('W'); p2.l++; p2.form.unshift('L'); } else if (r.score1 < r.score2) { p2.w++; p2.pts+=3; p2.form.unshift('W'); p1.l++; p1.form.unshift('L'); } else { p1.d++; p1.pts+=1; p1.form.unshift('D'); p2.d++; p2.pts+=1; p2.form.unshift('D'); } if(p1.form.length > 5) p1.form.pop(); if(p2.form.length > 5) p2.form.pop(); } }); const tbody = document.getElementById('standingsTable'); tbody.innerHTML = ''; leagueData.players.filter(p => p.eligible).sort((a,b) => (b.pts - a.pts) || (b.gd - a.gd) || (b.gf - a.gf)).forEach((p, i) => { const formHtml = p.form.map(f => `<span class="form-bubble form-bubble-${f}">${f}</span>`).join(''); tbody.innerHTML += `<tr><td class="fw-bold">${i+1}</td><td class="d-flex align-items-center"><img src="${p.avatar}" style="width:25px;height:25px;border-radius:50%;margin-right:5px;"> ${p.name}</td><td>${p.mp}</td><td>${p.w}</td><td>${p.d}</td><td>${p.l}</td><td>${p.gf}</td><td>${p.ga}</td><td>${p.gd > 0 ? '+'+p.gd : p.gd}</td><td>${formHtml}</td><td class="fw-bold">${p.pts}</td></tr>`; }); }
        function renderLeagueMatches() { const c = document.getElementById('fixturesContainer'); c.innerHTML = ''; const d = leagueData.fixtures.filter(f => f.matchday === currentMatchday); if(d.length > 0) document.getElementById('matchdayDateDisplay').innerText = "Date: " + new Date(d[0].date).toDateString(); else document.getElementById('matchdayDateDisplay').innerText = ""; if(d.length===0) c.innerHTML = '<p class="text-center text-secondary">No matches.</p>'; d.forEach(f => { const r = leagueData.results.find(x => x.fixtureId === f.id); c.innerHTML += createMatchCard(f, r, 'league'); }); document.getElementById('currentMatchday').textContent = `Matchday ${currentMatchday}`; }
        function createMatchCard(f, r, type) { const p1 = getPlayer(f.player1Id), p2 = getPlayer(f.player2Id), pend = leagueData.resultsPending.filter(x => x.fixtureId === f.id), allow = (f.date === new Date().toISOString().split('T')[0]), cls = type === 'league' ? 'match-type-league' : type === 'cup' ? 'match-type-cup' : 'match-type-shield'; if(f.isPlayed && r) { const w1 = r.score1 > r.score2 ? 'text-warning' : '', w2 = r.score2 > r.score1 ? 'text-warning' : ''; return `<div class="result-card ${cls}"><div class="result-player">${getContactLinks(p1)} <img src="${p1.avatar}"> ${p1.name}</div><div class="text-center"><div class="h3 fw-bold m-0"><span class="${w1}">${r.score1}</span> - <span class="${w2}">${r.score2}</span></div><div class="small text-muted">${type.toUpperCase()}</div></div><div class="result-player">${p2.name} <img src="${p2.avatar}"> ${getContactLinks(p2)}</div>${isAdmin ? `<button class="btn btn-sm btn-danger ms-2 admin-mode" onclick="undoResult('${f.id}', '${type}')"><i class="fa-solid fa-undo"></i></button>` : ''}</div>`; } else { if(pend.length > 0) { const h = pend.map(p => `<div class="border rounded p-2 mb-1 bg-white"><div class="d-flex justify-content-between align-items-center"><div><small class="text-muted">By <strong>${getPlayer(p.submittedByPlayerId).name}</strong></small><div>${getPlayer(p.homeId).name} <strong>${p.score1}-${p.score2}</strong> ${getPlayer(p.awayId).name}</div><div class="small text-${p.status==='disputed'?'danger':'warning'}">${p.status}</div></div><div>${(sessionTeamId===p.homeId||sessionTeamId===p.awayId) && p.status === 'pending' ? `<button class="btn btn-sm btn-success me-1" onclick="acceptPending('${p.id}', '${sessionTeamId}')"><i class="fa-solid fa-check"></i></button><button class="btn btn-sm btn-danger" onclick="disputePending('${p.id}', '${sessionTeamId}')"><i class="fa-solid fa-times"></i></button>` : ''}</div></div></div>`).join(''); return `<div class="match-card ${cls} flex-column"><div class="d-flex justify-content-between w-100 align-items-center mb-2"><div class="match-player">${getContactLinks(p1)} <img src="${p1.avatar}"> ${p1.name}</div><div class="small fw-bold">VS</div><div class="match-player">${p2.name} <img src="${p2.avatar}"> ${getContactLinks(p2)}</div></div><div style="width:100%">${h}</div></div>`; } const subBtn = (allow && (sessionTeamId===f.player1Id||sessionTeamId===f.player2Id)) ? `<button class="btn btn-sm btn-outline-success ms-2" onclick="openPlayerSubmitModal('${f.id}')"><i class="fa-solid fa-check"></i> Submit</button>` : ''; return `<div class="match-card ${cls}"><div class="match-player">${getContactLinks(p1)} <img src="${p1.avatar}"> ${p1.name}</div><div class="text-center small text-muted">VS</div><div class="match-player">${p2.name} <img src="${p2.avatar}"> ${getContactLinks(p2)}</div><div>${isAdmin ? `<button class="btn btn-sm btn-primary ms-2 admin-mode" onclick="showResultModal('${f.id}', '${type}')"><i class="fa-solid fa-pen"></i></button>` : ''}${subBtn}</div></div>`; } }
        function openPlayerSubmitModal(fid) { const f = findFixtureById(fid); if(!f) return; const hS = document.getElementById('ps_homeSelect'), aS = document.getElementById('ps_awaySelect'), h = getPlayer(f.player1Id), a = getPlayer(f.player2Id); hS.innerHTML = `<option value="${f.player1Id}">${h.name}</option><option value="${f.player2Id}">${a.name}</option>`; aS.innerHTML = `<option value="${f.player2Id}">${a.name}</option><option value="${f.player1Id}">${h.name}</option>`; document.getElementById('ps_fixtureId').value = fid; document.getElementById('ps_score1').value = 0; document.getElementById('ps_score2').value = 0; if(sessionTeamId) { if(sessionTeamId === f.player1Id) hS.value = f.player1Id; if(sessionTeamId === f.player2Id) hS.value = f.player2Id; } new bootstrap.Modal(document.getElementById('playerSubmitModal')).show(); }
        async function submitPlayerResult() { const fid = document.getElementById('ps_fixtureId').value, hid = document.getElementById('ps_homeSelect').value, aid = document.getElementById('ps_awaySelect').value, s1 = parseInt(document.getElementById('ps_score1').value)||0, s2 = parseInt(document.getElementById('ps_score2').value)||0; if(!sessionTeamId || (sessionTeamId!==hid && sessionTeamId!==aid)) return showToast("Submit for own team only.", "danger"); if(leagueData.resultsPending.find(p=>p.fixtureId===fid && p.status==='pending')) return showToast("Result pending.", "danger"); leagueData.resultsPending.push({ id:'p'+Date.now(), fixtureId:fid, submittedByPlayerId:sessionTeamId, homeId:hid, awayId:aid, score1:s1, score2:s2, timestamp:Date.now(), expiresAt:Date.now()+21600000, status:'pending' }); logActivity(sessionTeamId,'result_submit',`Sub ${s1}-${s2}`); await saveData(); new bootstrap.Modal(document.getElementById('playerSubmitModal')).hide(); showToast("Pending.", "info"); updateViews(); }
        function showResultModal(id, type) { const f = findFixtureById(id); document.getElementById('resultMatchId').value = id; document.getElementById('resultMatchType').value = type; document.getElementById('resultPlayer1Name').textContent = getPlayer(f.player1Id).name; document.getElementById('resultPlayer2Name').textContent = getPlayer(f.player2Id).name; const r = type==='league'?leagueData.results.find(x=>x.fixtureId===id):f.result; document.getElementById('resultScore1').value = r?r.score1:0; document.getElementById('resultScore2').value = r?r.score2:0; new bootstrap.Modal(document.getElementById('resultModal')).show(); }
        async function submitResult() { const id = document.getElementById('resultMatchId').value, type = document.getElementById('resultMatchType').value, s1 = parseInt(document.getElementById('resultScore1').value), s2 = parseInt(document.getElementById('resultScore2').value); if(type === 'league') { const f = leagueData.fixtures.find(x => x.id === id); f.isPlayed = true; leagueData.results = leagueData.results.filter(r => r.fixtureId !== id); leagueData.results.push({ fixtureId: id, player1Id: f.player1Id, player2Id: f.player2Id, score1: s1, score2: s2, timestamp: Date.now() }); } else if (type === 'cup') { const f = leagueData.cupFixtures.find(x => x.id === id); f.isPlayed = true; f.result = { score1: s1, score2: s2 }; } else { leagueData.shieldMatch.fixture.isPlayed = true; leagueData.shieldMatch.fixture.result = { score1: s1, score2: s2 }; } await saveData(); updateViews(); bootstrap.Modal.getInstance(document.getElementById('resultModal')).hide(); }
        async function undoResult(id, type) { if(type === 'league') { leagueData.fixtures.find(x => x.id === id).isPlayed = false; leagueData.results = leagueData.results.filter(r => r.fixtureId !== id); } else if (type === 'cup') { const f = leagueData.cupFixtures.find(x => x.id === id); f.isPlayed = false; f.result = null; } else { leagueData.shieldMatch.fixture.isPlayed = false; leagueData.shieldMatch.fixture.result = null; } await saveData(); updateViews(); }
        function getWinners() { const s = leagueData.players.filter(p=>p.eligible).sort((a,b)=>(b.pts-a.pts)||(b.gd-a.gd)||(b.gf-a.gf)); const lw=s[0]?s[0].name:"None", lr=s[1]?s[1].name:"None"; let cw="None", cr="None"; const cf = leagueData.cupFixtures.find(f=>f.roundName==='Final'&&f.isPlayed); if(cf&&cf.result) { const p1=getPlayer(cf.player1Id).name, p2=getPlayer(cf.player2Id).name; if(cf.result.score1>cf.result.score2){cw=p1;cr=p2}else{cw=p2;cr=p1} } let sw="None", sr="None"; if(leagueData.shieldMatch&&leagueData.shieldMatch.fixture.isPlayed){const f=leagueData.shieldMatch.fixture, p1=getPlayer(f.player1Id).name, p2=getPlayer(f.player2Id).name; if(f.result.score1>f.result.score2){sw=p1;sr=p2}else{sw=p2;sr=p1}} return {league:{w:lw,r:lr},cup:{w:cw,r:cr},shield:{w:sw,r:sr}}; }
        async function endSeasonManual() { if(!isAdmin || !confirm("End Season?")) return; const w = getWinners(); leagueData.seasonHistory.unshift({season:leagueData.seasonNumber, timestamp:Date.now(), champions:w}); leagueData.seasonNumber++; leagueData.seasonEndTime = null; leagueData.fixtures=[]; leagueData.results=[]; leagueData.resultsPending=[]; leagueData.cupFixtures=[]; leagueData.shieldMatch=null; leagueData.players.forEach(p=>{p.mp=0;p.w=0;p.d=0;p.l=0;p.gf=0;p.ga=0;p.gd=0;p.pts=0;p.form=[];p.penaltyCount=0;}); await saveData(); updateViews(); showToast("Season Ended", "success"); }
        function renderTrophyRoomButtons() { const n = document.getElementById('trophySeasonTabs'), c = document.getElementById('trophyContainer'); n.innerHTML = ''; if(!leagueData.seasonHistory.length) { c.innerHTML = '<p class="text-center text-secondary py-4">No history.</p>'; return; } leagueData.seasonHistory.forEach((e,i) => n.innerHTML += `<button class="btn btn-sm ${i===0?'btn-primary':'btn-outline-secondary'} trophy-btn rounded-pill" onclick="showSeasonHistory(${e.season}, this)">S${e.season}</button>`); showSeasonHistory(leagueData.seasonHistory[0].season, n.firstElementChild); }
        window.showSeasonHistory = function(sn, btn) { document.querySelectorAll('.trophy-btn').forEach(b => { b.classList.remove('btn-primary'); b.classList.add('btn-outline-secondary'); }); if(btn) { btn.classList.remove('btn-outline-secondary'); btn.classList.add('btn-primary'); } const e = leagueData.seasonHistory.find(s => s.season === sn); if(!e) return; document.getElementById('trophyContainer').innerHTML = `<div class="card p-4 mt-3 animate__animated animate__fadeIn"><div class="text-center mb-3"><h3 class="fw-bold text-uppercase">Season ${e.season}</h3><small>${new Date(e.timestamp).toLocaleDateString()}</small></div><div class="row g-3"><div class="col-md-4"><div class="border rounded p-3 text-center bg-dark"><div class="text-warning mb-2"><i class="fa-solid fa-trophy fa-2x"></i></div><h5>LEAGUE</h5><div class="text-success fw-bold">1st: ${e.champions.league.w}</div><div>2nd: ${e.champions.league.r}</div></div></div><div class="col-md-4"><div class="border rounded p-3 text-center bg-dark"><div class="text-danger mb-2"><i class="fa-solid fa-wine-glass fa-2x"></i></div><h5>CUP</h5><div class="text-success fw-bold">Winner: ${e.champions.cup.w}</div><div>Runner: ${e.champions.cup.r}</div></div></div><div class="col-md-4"><div class="border rounded p-3 text-center bg-dark"><div class="text-info mb-2"><i class="fa-solid fa-shield-halved fa-2x"></i></div><h5>SHIELD</h5><div class="text-success fw-bold">Winner: ${e.champions.shield.w}</div><div>Runner: ${e.champions.shield.r}</div></div></div></div></div>`; }
        function calculateTotalMatchdays() { totalMatchdays = Math.max(1, ...leagueData.fixtures.map(f => f.matchday)); }
        function calculateCupRounds() { const r = [...new Set(leagueData.cupFixtures.map(f => f.roundName))]; const o = { 'Final': 10, 'Semi-Final': 5, 'Quarter-Final': 3 }; cupRounds = r.sort((a,b) => (o[a]||1) - (o[b]||1)); currentCupRoundIndex = Math.max(0, cupRounds.length - 1); }
        function changeMatchday(d) { if(currentMatchday+d > 0 && currentMatchday+d <= totalMatchdays) { currentMatchday+=d; renderLeagueMatches(); }}
        function changeCupRound(d) { if(currentCupRoundIndex+d >= 0 && currentCupRoundIndex+d < cupRounds.length) { currentCupRoundIndex+=d; renderCupMatches(); }}
        function loginAdmin() { const p = document.getElementById('adminPassword').value; if(p === password) { isAdmin = true; isSubAdmin = false; showToast("Admin", "success"); } else if(p === leagueData.subAdminPassword) { isSubAdmin = true; isAdmin = false; showToast("Sub-Admin", "success"); } else showToast("Wrong", "danger"); bootstrap.Modal.getInstance(document.getElementById('adminModal')).hide(); updateViews(); populatePredictionSelects(); }
        function updatePlayers() { const c = document.getElementById('playersContainer'); c.innerHTML = ''; leagueData.players.forEach(p => { c.innerHTML += `<div class="col"><div class="card p-3 text-center h-100 position-relative"><div class="badge bg-danger position-absolute top-0 start-0 m-2">${p.penaltyCount || 0} <i class="fa-solid fa-flag"></i></div><img src="${p.avatar}" style="width:80px;height:80px;border-radius:50%;margin:0 auto;" class="border border-3 border-success mb-2"><h6 class="text-truncate">${p.name}</h6><div class="d-flex justify-content-center mb-2">${getContactLinks(p)}</div><div class="admin-mode"><button class="btn btn-sm btn-danger" onclick="deletePlayer('${p.id}')"><i class="fa-solid fa-trash"></i></button>${p.eligible ? `<button class="btn btn-sm btn-outline-warning" onclick="setEligibility('${p.id}', false)">Block</button>` : `<button class="btn btn-sm btn-outline-success" onclick="setEligibility('${p.id}', true)">Approve</button>`}</div></div></div>`; }); }
        async function setEligibility(id, v) { if(!isAdmin) return; const p = leagueData.players.find(x => x.id === id); p.eligible = !!v; await saveData(); updateViews(); }
        async function submitPlayer() { const n = document.getElementById('playerName').value; if(!n) return; leagueData.players.push({ id: Date.now().toString(), name: n, avatar: document.getElementById('playerAvatarUrl').value || defaultAvatar, socialLink: document.getElementById('playerSocialLink').value, phone: document.getElementById('playerPhone').value, mp:0, w:0, d:0, l:0, gf:0, ga:0, gd:0, pts:0, form:[], penaltyCount: 0, eligible: true }); await saveData(); updateViews(); bootstrap.Modal.getInstance(document.getElementById('addPlayerModal')).hide(); }
        async function deletePlayer(id) { if(!confirm("Delete?")) return; leagueData.players = leagueData.players.filter(p => p.id !== id); await saveData(); updateViews(); }
        async function generateCup() { if(!isAdmin) return; leagueData.cupFixtures = []; const ids = leagueData.players.filter(p => p.eligible).map(p => p.id).sort(() => 0.5 - Math.random()); if(ids.length < 2) return; const size = Math.pow(2, Math.ceil(Math.log2(ids.length))), rn = size === 2 ? 'Final' : size === 4 ? 'Semi-Final' : `Round of ${size}`; while(ids.length < size) ids.push('BYE'); for(let i=0; i<ids.length; i+=2) { const bye = ids[i+1] === 'BYE'; leagueData.cupFixtures.push({ id: `cup-${Date.now()}-${i}`, player1Id: ids[i], player2Id: ids[i+1], roundName: rn, date: new Date().toISOString().split('T')[0], isPlayed: bye, result: bye ? {score1: 1, score2: 0} : null }); } await saveData(); calculateCupRounds(); updateViews(); }
        async function generateNextCupRound() { if(!isAdmin) return; const cr = cupRounds[cupRounds.length-1]; const m = leagueData.cupFixtures.filter(f => f.roundName === cr); if(m.some(f => !f.isPlayed)) return showToast("Finish round first", "danger"); const w = m.map(f => { if(f.player2Id === 'BYE') return f.player1Id; return f.result.score1 > f.result.score2 ? f.player1Id : f.player2Id; }); const ns = w.length, nn = ns === 2 ? 'Final' : ns === 4 ? 'Semi-Final' : `Round of ${ns}`; for(let i=0; i<w.length; i+=2) { leagueData.cupFixtures.push({ id: `cup-${Date.now()}-${i}`, player1Id: w[i], player2Id: w[i+1], roundName: nn, date: new Date().toISOString().split('T')[0], isPlayed: false, result: null }); } await saveData(); calculateCupRounds(); currentCupRoundIndex = cupRounds.length-1; updateViews(); }
        function showAddPlayerModal() { new bootstrap.Modal(document.getElementById('addPlayerModal')).show(); }
        function showActivityLogModal() { const c = document.getElementById('activityLogContent'); c.innerHTML = leagueData.activityLog.slice().reverse().map(e => `<div class="border-bottom py-2"><div class="small text-muted">${new Date(e.timestamp).toLocaleTimeString()} - ${e.userId}</div><div>${e.details}</div></div>`).join('') || 'None'; new bootstrap.Modal(document.getElementById('activityLogModal')).show(); }
        function showTimerModal() { if(!isAdmin) return; new bootstrap.Modal(document.getElementById('timerModal')).show(); }
        async function setTimer() { const d=parseInt(document.getElementById('timerDays').value)||0, h=parseInt(document.getElementById('timerHours').value)||0, m=parseInt(document.getElementById('timerMinutes').value)||0; if(!d&&!h&&!m) return; leagueData.seasonEndTime = Date.now()+(d*86400000)+(h*3600000)+(m*60000); await saveData(); checkSeasonTimer(); bootstrap.Modal.getInstance(document.getElementById('timerModal')).hide(); }
        async function clearTimer() { leagueData.seasonEndTime = null; await saveData(); checkSeasonTimer(); bootstrap.Modal.getInstance(document.getElementById('timerModal')).hide(); }
        function checkSeasonTimer() { clearInterval(timerInterval); const c = document.getElementById('seasonTimerContainer'); if (!leagueData.seasonEndTime) { c.style.display = 'none'; return; } c.style.display = 'block'; timerInterval = setInterval(() => { const dist = leagueData.seasonEndTime - Date.now(); if (dist < 0) { clearInterval(timerInterval); c.style.display = 'none'; endSeasonManual(); } else { const d = Math.floor(dist / (1000 * 60 * 60 * 24)), h = Math.floor((dist % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)), m = Math.floor((dist % (1000 * 60 * 60)) / (1000 * 60)); document.getElementById('seasonTimerDisplay').innerText = `${d}d ${h}h ${m}m`; } }, 60000); }
        async function submitBackground() { leagueData.backgroundUrl = `url('${document.getElementById('backgroundUrl').value}')`; await saveData(); applyBackground(); bootstrap.Modal.getInstance(document.getElementById('editBackgroundModal')).hide(); }
        function applyBackground() { document.documentElement.style.setProperty('--hero-bg-url', leagueData.backgroundUrl); }
        async function submitCupImage() { leagueData.cupImageUrl = document.getElementById('cupImageUrlInput').value; await saveData(); updateViews(); bootstrap.Modal.getInstance(document.getElementById('setCupImageModal')).hide(); }
        function showSetShieldModal() { populateSelectors(['shieldPlayer1', 'shieldPlayer2']); new bootstrap.Modal(document.getElementById('setShieldModal')).show(); }
        async function submitShieldMatch() { leagueData.shieldMatch = { fixture: { id:'shield', player1Id: document.getElementById('shieldPlayer1').value, player2Id: document.getElementById('shieldPlayer2').value, date: document.getElementById('shieldDate').value, isPlayed:false, result:null }, imageUrl: document.getElementById('shieldImageUrl').value }; await saveData(); updateViews(); bootstrap.Modal.getInstance(document.getElementById('setShieldModal')).hide(); }
        function showAddFixtureModal() { populateSelectors(['fixturePlayer1', 'fixturePlayer2']); new bootstrap.Modal(document.getElementById('addFixtureModal')).show(); }
        async function submitFixture() { leagueData.fixtures.push({ id: Date.now().toString(), player1Id: document.getElementById('fixturePlayer1').value, player2Id: document.getElementById('fixturePlayer2').value, date: document.getElementById('fixtureDate').value, matchday: parseInt(document.getElementById('fixtureMatchday').value), isPlayed: false }); calculateTotalMatchdays(); await saveData(); updateViews(); bootstrap.Modal.getInstance(document.getElementById('addFixtureModal')).hide(); }
        function showSetSubAdminModal() { if(!isAdmin) return; populateSelectors(['subAdminPlayerSelect']); new bootstrap.Modal(document.getElementById('subAdminModal')).show(); }
        async function setSubAdmin() { leagueData.subAdminPlayerId = document.getElementById('subAdminPlayerSelect').value; leagueData.subAdminPassword = document.getElementById('subAdminPasswordInput').value; await saveData(); bootstrap.Modal.getInstance(document.getElementById('subAdminModal')).hide(); }
        async function removeSubAdmin() { leagueData.subAdminPlayerId = null; leagueData.subAdminPassword = ''; await saveData(); bootstrap.Modal.getInstance(document.getElementById('subAdminModal')).hide(); }
        function showEditBackgroundModal() { new bootstrap.Modal(document.getElementById('editBackgroundModal')).show(); }
        function showSetCupImageModal() { new bootstrap.Modal(document.getElementById('setCupImageModal')).show(); }
        function populateSelectors(ids) { ids.forEach(id => { const s = document.getElementById(id); s.innerHTML = '<option value="">Select Player</option>'; leagueData.players.filter(p => p.eligible).forEach(p => s.innerHTML += `<option value="${p.id}">${p.name}</option>`); }); }
        function updateLiveTicker() { const t = document.querySelector('.live-ticker-content'); if(!leagueData.results.length) { t.textContent = "Welcome to E-Football League! Season " + leagueData.seasonNumber; return; } const r = leagueData.results.sort((a,b)=>b.timestamp-a.timestamp)[0]; const p1 = getPlayer(r.player1Id).name, p2 = getPlayer(r.player2Id).name; t.textContent = `LATEST: ${p1} ${r.score1} - ${r.score2} ${p2} | SEASON ${leagueData.seasonNumber} LIVE`; }
        function logActivity(uid, act, det) { leagueData.activityLog = leagueData.activityLog || []; leagueData.activityLog.push({ userId: uid || 'unknown', action: act, details: det, timestamp: Date.now() }); if(leagueData.activityLog.length > 1000) leagueData.activityLog.splice(0, 100); db.collection('league').doc('data').set({ ...leagueData }).catch(console.error); }
        function showToast(m, t) { const b = document.getElementById('toast-container'); const el = document.createElement('div'); el.className = `toast show bg-${t} text-white`; el.innerHTML = `<div class="toast-body">${m}</div>`; b.appendChild(el); setTimeout(() => el.remove(), 3000); }
        function renderCupMatches() { const c = document.getElementById('cupContainer'); c.innerHTML = ''; if(!cupRounds.length) { c.innerHTML = '<p class="text-center text-secondary">No Cup generated.</p>'; return; } const rn = cupRounds[currentCupRoundIndex]; document.getElementById('cupRoundName').textContent = rn; if(leagueData.cupImageUrl && rn !== 'Final') c.innerHTML += `<div class="col-12 text-center"><img src="${leagueData.cupImageUrl}" style="max-height:150px; border-radius:8px;"></div>`; leagueData.cupFixtures.filter(f => f.roundName === rn && f.player2Id !== 'BYE').forEach(f => { c.innerHTML += `<div class="col-md-6">${createMatchCard(f, f.result, 'cup')}</div>`; }); if(rn === 'Final' && leagueData.cupImageUrl) c.innerHTML += `<div class="col-12 text-center mt-2"><img src="${leagueData.cupImageUrl}" class="img-fluid rounded" style="max-height:300px;"></div>`; }
        function renderShieldMatch() { const c = document.getElementById('shieldMatchContainer'); if(!leagueData.shieldMatch) { c.innerHTML = '<p class="text-center text-secondary">Shield match not set.</p>'; return; } const f = leagueData.shieldMatch.fixture; c.innerHTML = `<div class="col-md-8">${createMatchCard(f, f.result, 'shield')}</div>`; if(leagueData.shieldMatch.imageUrl) c.innerHTML += `<div class="col-12 text-center mt-3"><img src="${leagueData.shieldMatch.imageUrl}" class="img-fluid rounded" style="max-height:300px;"></div>`; }
    </script>
</body>
</html>